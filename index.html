<!DOCTYPE html>
<!-- 
  For Netlify deployment:
  Create a file named _redirects in your publish directory with:
     /* /index.html 200
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#2ECC71">
    <title>Performance Coach Pro</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #2ECC71 0%, #27AE60 100%);
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
            touch-action: pan-y;
        }
        
        /* Leafy shadow effects - green leaves floating */
        body:before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(ellipse 60px 90px at 15% 20%, rgba(39,174,96,0.15) 0%, transparent 60%),
                radial-gradient(ellipse 80px 120px at 85% 15%, rgba(46,204,113,0.12) 0%, transparent 60%),
                radial-gradient(ellipse 50px 75px at 10% 60%, rgba(39,174,96,0.18) 0%, transparent 60%),
                radial-gradient(ellipse 70px 105px at 90% 70%, rgba(46,204,113,0.15) 0%, transparent 60%),
                radial-gradient(ellipse 55px 85px at 50% 30%, rgba(39,174,96,0.10) 0%, transparent 60%),
                radial-gradient(ellipse 65px 95px at 25% 80%, rgba(46,204,113,0.14) 0%, transparent 60%),
                radial-gradient(ellipse 75px 110px at 70% 50%, rgba(39,174,96,0.16) 0%, transparent 60%),
                radial-gradient(ellipse 45px 70px at 40% 45%, rgba(46,204,113,0.11) 0%, transparent 60%),
                radial-gradient(ellipse 85px 125px at 60% 85%, rgba(39,174,96,0.13) 0%, transparent 60%);
            pointer-events: none;
            z-index: 0;
            animation: leafFloat 20s ease-in-out infinite;
        }
        
        @keyframes leafFloat {
            0%, 100% { opacity: 1; transform: translateY(0px); }
            50% { opacity: 0.8; transform: translateY(-10px); }
        }
        
        .app-container {
            position: relative;
            z-index: 1;
            max-width: 480px;
            margin: 0 auto;
            min-height: 100vh;
            background: transparent;
        }
        
        /* Top Bar */
        .top-bar {
            position: sticky;
            top: 0;
            background: white;
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 100;
            display: none; /* hidden by default; shown only when authenticated */
            justify-content: space-between;
            align-items: center;
        }
        
        .back-btn {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            background: #E8F5E9;
            border-radius: 8px;
            border: none;
            font-size: 1.5em;
            color: #2ECC71;
        }
        
        .logout-btn {
            padding: 8px 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            cursor: pointer;
            background: #FFE6E6;
            border-radius: 8px;
            border: 2px solid #E74C3C;
            font-size: 0.9em;
            font-weight: 600;
            color: #E74C3C;
            transition: all 0.2s ease;
        }
        
        .logout-btn:active {
            transform: scale(0.95);
            background: #E74C3C;
            color: white;
        }
        
        .app-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #1E8449;
        }
        
        .menu-btn {
            width: 40px;
            height: 40px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            background: #E8F5E9;
            border-radius: 8px;
            border: none;
        }
        
        .menu-btn span {
            width: 20px;
            height: 2px;
            background: #2ECC71;
            border-radius: 2px;
            transition: all 0.3s ease;
        }
        
        /* Minimalistic Exit Button - Door Shape / Back Arrow */
        .exit-btn {
            width: 28px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            background: transparent;
            border: 2px solid #E8F5E9;
            border-radius: 4px 4px 0 0;
            font-size: 0.7em;
            color: #95a5a6;
            font-weight: 300;
            transition: all 0.2s ease;
            padding: 0;
            position: relative;
        }
        
        /* Door vertical line */
        .exit-btn:before {
            content: '';
            position: absolute;
            width: 2px;
            height: 18px;
            background: #95a5a6;
            left: 50%;
            transform: translateX(-50%);
            transition: all 0.2s ease;
        }
        
        /* Door handle or back arrow tip */
        .exit-btn:after {
            content: '';
            position: absolute;
            width: 4px;
            height: 4px;
            background: #95a5a6;
            right: 6px;
            top: 50%;
            transform: translateY(-50%);
            border-radius: 50%;
            transition: all 0.2s ease;
        }
        
        /* When back button (rounded) - change to arrow */
        .exit-btn[style*="border-radius: 8px"]:before {
            width: 10px;
            height: 2px;
            left: 8px;
            transform: rotate(45deg);
            transform-origin: left center;
        }
        
        .exit-btn[style*="border-radius: 8px"]:after {
            width: 10px;
            height: 2px;
            right: auto;
            left: 8px;
            top: calc(50% - 1px);
            transform: rotate(-45deg);
            transform-origin: left center;
            border-radius: 0;
        }
        
        .exit-btn:hover {
            border-color: #E74C3C;
            background: #FFE6E6;
        }
        
        .exit-btn:hover:before,
        .exit-btn:hover:after {
            background: #E74C3C;
        }
        
        .exit-btn:active {
            transform: scale(0.95);
            background: #E74C3C;
            border-color: #E74C3C;
        }
        
        .exit-btn:active:before,
        .exit-btn:active:after {
            background: white;
        }
        
        /* Quick Access Buttons */
        .quick-btn {
            width: 40px;
            height: 40px;
            background: #E8F5E9;
            border: none;
            border-radius: 8px;
            font-size: 1.3em;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .quick-btn:active {
            transform: scale(0.95);
            background: #2ECC71;
        }
        
        /* Buddy Speech Bubble */
        .buddy-speech {
            position: fixed;
            bottom: 160px;
            right: 20px;
            background: white;
            padding: 12px 16px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            max-width: 200px;
            z-index: 46;
            animation: bubbleAppear 0.3s ease;
            border: 2px solid #2ECC71;
        }
        
        .buddy-speech:after {
            content: '';
            position: absolute;
            bottom: -10px;
            right: 30px;
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-top: 10px solid white;
        }
        
        .buddy-speech:before {
            content: '';
            position: absolute;
            bottom: -13px;
            right: 28px;
            width: 0;
            height: 0;
            border-left: 12px solid transparent;
            border-right: 12px solid transparent;
            border-top: 12px solid #2ECC71;
        }
        
        @keyframes bubbleAppear {
            0% {
                opacity: 0;
                transform: scale(0.8) translateY(10px);
            }
            100% {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        
        .buddy-speech-text {
            color: #2C3E50;
            font-size: 0.9em;
            font-weight: 600;
            line-height: 1.4;
        }
        
        .buddy-speech-emoji {
            font-size: 1.2em;
            margin-right: 5px;
        }
        
        /* Side Menu */
        .side-menu {
            position: fixed;
            top: 0;
            right: -100%;
            width: 80%;
            max-width: 300px;
            height: 100vh;
            background: white;
            box-shadow: -4px 0 20px rgba(0,0,0,0.3);
            transition: right 0.3s ease;
            z-index: 200;
            overflow-y: auto;
        }
        
        .side-menu.active {
            right: 0;
        }
        
        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 199;
        }
        
        .menu-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .menu-header {
            background: linear-gradient(135deg, #2ECC71 0%, #27AE60 100%);
            padding: 30px 20px;
            color: white;
        }
        
        .menu-user {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .menu-role {
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        .menu-items {
            padding: 10px 0;
        }
        
        .menu-item {
            padding: 22px 20px;
            display: flex;
            align-items: center;
            gap: 18px;
            cursor: pointer;
            transition: background 0.2s ease;
            border-left: 3px solid transparent;
        }
        
        .menu-item:active {
            background: #f5f7f6;
        }
        
        .menu-item.active {
            background: #E8F5E9;
            border-left-color: #2ECC71;
        }
        
        .menu-icon {
            font-size: 2em;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 80px;
        }
        
        .menu-text {
            font-weight: 600;
            color: #2C3E50;
        }
        
        .menu-divider {
            height: 1px;
            background: #E8F5E9;
            margin: 10px 20px;
        }
        
        /* Content Area */
        .content {
            padding: 20px;
            padding-bottom: 20px;
        }
        
        .page {
            display: none;
        }
        
        .page.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Card */
        .card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }
        
        .card-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #1E8449;
            margin-bottom: 15px;
        }
        
        /* Training Days */
        .day-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            border-left: 5px solid #95a5a6;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .day-card:active {
            transform: scale(0.98);
        }
        
        .day-card.completed {
            background: #E8F5E9;
            border-left-color: #2ECC71;
        }
        
        .day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .day-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .day-letter {
            font-size: 2em;
            font-weight: bold;
            color: #1E8449;
            width: 50px;
            height: 50px;
            background: #E8F5E9;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .day-info h3 {
            color: #1E8449;
            margin-bottom: 5px;
        }
        
        .day-info p {
            color: #7f8c8d;
            font-size: 0.9em;
        }
        
        .day-arrow {
            font-size: 1.5em;
            color: #2ECC71;
        }
        
        /* Exercise Detail Card */
        .exercise-detail-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            border-left: 4px solid #2ECC71;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .exercise-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #E8F5E9;
        }
        
        .exercise-name {
            font-size: 1.1em;
            font-weight: bold;
            color: #1E8449;
        }
        
        .delete-exercise {
            color: #E74C3C;
            font-size: 1.3em;
            cursor: pointer;
            padding: 5px 10px;
        }
        
        .exercise-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .input-group {
            margin-bottom: 10px;
        }
        
        .input-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            font-size: 0.85em;
            color: #2C3E50;
        }
        
        .input-field {
            width: 100%;
            padding: 10px;
            border: 2px solid #E8F5E9;
            border-radius: 8px;
            font-size: 1em;
            outline: none;
        }
        
        .input-field:focus {
            border-color: #2ECC71;
        }
        
        .input-field.small {
            padding: 8px;
            font-size: 0.95em;
        }
        
        .notes-section {
            margin-top: 15px;
        }
        
        .notes-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .note-badge {
            font-size: 0.75em;
            padding: 3px 8px;
            border-radius: 12px;
            font-weight: 600;
        }
        
        .note-coach {
            background: #E7F3FF;
            color: #2196F3;
        }
        
        .note-trainee {
            background: #FFF3CD;
            color: #856404;
        }
        
        .note-text {
            background: #f5f7f6;
            padding: 10px;
            border-radius: 8px;
            font-size: 0.9em;
            color: #2C3E50;
            margin-bottom: 8px;
        }
        
        /* Buttons */
        .btn {
            padding: 14px 24px;
            border-radius: 12px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 1em;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn:active {
            transform: scale(0.98);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #2ECC71 0%, #27AE60 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(46, 204, 113, 0.3);
        }
        
        .btn-secondary {
            background: #f5f7f6;
            color: #2C3E50;
        }
        
        .btn-outline {
            background: transparent;
            border: 2px solid #2ECC71;
            color: #2ECC71;
        }
        
        .btn-danger {
            background: #E74C3C;
            color: white;
        }
        
        .btn-small {
            padding: 8px 16px;
            font-size: 0.9em;
        }
        
        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 50;
        }
        
        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            padding: 8px;
            cursor: pointer;
            color: #95a5a6;
            transition: color 0.2s ease;
        }
        
        .nav-item.active {
            color: #2ECC71;
        }
        
        .nav-icon {
            font-size: 1.5em;
        }
        
        .nav-label {
            font-size: 0.7em;
            font-weight: 600;
        }
        
        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 300;
            padding: 20px;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 25px;
            max-width: 400px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #1E8449;
            margin-bottom: 20px;
        }
        
        .modal-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }
        
        /* Code Input */
        .code-input {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }
        
        .code-digit {
            width: 50px;
            height: 60px;
            font-size: 2em;
            text-align: center;
            border: 2px solid #E8F5E9;
            border-radius: 12px;
            outline: none;
        }
        
        .code-digit:focus {
            border-color: #2ECC71;
        }
        
        .error-message {
            color: #E74C3C;
            text-align: center;
            margin-top: 10px;
            font-weight: 600;
        }
        
        /* Performance Score */
        .score-circle {
            width: 180px;
            height: 180px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 20px auto;
            position: relative;
        }
        
        .score-ring {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 12px solid #E8F5E9;
        }
        
        .score-value {
            font-size: 3.5em;
            font-weight: bold;
            z-index: 1;
        }
        
        .score-label {
            font-size: 0.9em;
            color: #7f8c8d;
            z-index: 1;
        }
        
        .score-status {
            text-align: center;
            margin-top: 10px;
            font-size: 1.1em;
            font-weight: bold;
            padding: 10px;
            border-radius: 8px;
        }
        
        .status-elite {
            background: #D4EDDA;
            color: #155724;
        }
        
        .status-track {
            background: #FFF3CD;
            color: #856404;
        }
        
        .status-attention {
            background: #F8D7DA;
            color: #721C24;
        }
        
        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        
        .stat-card {
            background: #E8F5E9;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
        }
        
        .stat-icon {
            font-size: 2em;
            margin-bottom: 8px;
        }
        
        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #1E8449;
        }
        
        .stat-label {
            color: #7f8c8d;
            font-size: 0.85em;
            margin-top: 5px;
        }
        
        /* Mission Card */
        .mission-card {
            background: linear-gradient(135deg, #E8F5E9 0%, #A9F5C1 100%);
            border-radius: 12px;
            padding: 20px;
            margin-top: 15px;
        }
        
        .mission-title {
            font-size: 0.85em;
            color: #1E8449;
            font-weight: 600;
            margin-bottom: 10px;
            text-transform: uppercase;
        }
        
        .mission-text {
            font-size: 1.1em;
            font-weight: bold;
            color: #2C3E50;
            margin-bottom: 15px;
        }
        
        /* Slider */
        .slider-container {
            margin-top: 20px;
        }
        
        .slider-value {
            font-size: 3em;
            font-weight: bold;
            text-align: center;
            margin-bottom: 10px;
            color: #2ECC71;
        }
        
        .slider-labels {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 0.85em;
            color: #7f8c8d;
        }
        
        .slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: white;
            outline: none;
            -webkit-appearance: none;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: #2ECC71;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(46, 204, 113, 0.4);
        }
        
        .slider::-moz-range-thumb {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: #2ECC71;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 8px rgba(46, 204, 113, 0.4);
        }
        
        /* Chat */
        .chat-messages {
            max-height: 400px;
            overflow-y: auto;
            margin: 15px 0;
            padding: 10px;
            background: #f5f7f6;
            border-radius: 12px;
        }
        
        .message {
            margin: 10px 0;
            padding: 12px 15px;
            border-radius: 16px;
            max-width: 80%;
            word-wrap: break-word;
            animation: messageSlide 0.3s ease;
        }
        
        @keyframes messageSlide {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message.coach {
            background: #E8F5E9;
            margin-left: 0;
            margin-right: auto;
            border: 2px solid #2ECC71;
            border-radius: 16px 16px 16px 4px;
        }
        
        .message.trainee {
            background: white;
            margin-left: auto;
            margin-right: 0;
            border: 2px solid #E8F5E9;
            border-radius: 16px 16px 4px 16px;
        }
        
        .message-sender {
            font-size: 0.75em;
            color: #7f8c8d;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .message-text {
            color: #2C3E50;
        }
        
        .message-time {
            font-size: 0.7em;
            color: #95a5a6;
            margin-top: 5px;
        }
        
        .chat-input-container {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .chat-input {
            flex: 1;
            padding: 14px;
            border: 2px solid #E8F5E9;
            border-radius: 12px;
            font-size: 1em;
            outline: none;
        }
        
        .chat-input:focus {
            border-color: #2ECC71;
        }
        
        .send-btn {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #2ECC71 0%, #27AE60 100%);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .send-btn:active {
            transform: scale(0.95);
        }
        
        .fab {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #2ECC71 0%, #27AE60 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2em;
            box-shadow: 0 4px 20px rgba(46, 204, 113, 0.4);
            cursor: pointer;
            z-index: 40;
        }
        
        .fab:active {
            transform: scale(0.95);
        }
        
        /* Animated Dumbbell Character */
        .dumbbell-buddy {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 80px;
            height: 60px;
            z-index: 45;
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        
        .dumbbell-buddy:hover {
            transform: scale(1.1);
        }
        
        .dumbbell-buddy:active {
            transform: scale(0.95);
        }
        
        .dumbbell-body {
            position: relative;
            width: 100%;
            height: 100%;
            animation: float 3s ease-in-out infinite;
            pointer-events: all;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        .dumbbell-left-weight, .dumbbell-right-weight {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 40px;
            background: linear-gradient(135deg, #1E8449 0%, #27AE60 100%);
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .dumbbell-left-weight {
            left: 0;
        }
        
        .dumbbell-right-weight {
            right: 0;
        }
        
        .dumbbell-bar {
            position: absolute;
            left: 18px;
            right: 18px;
            top: 50%;
            transform: translateY(-50%);
            height: 12px;
            background: linear-gradient(135deg, #2C3E50 0%, #34495E 100%);
            border-radius: 6px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .dumbbell-face {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 30px;
            height: 30px;
            background: white;
            border-radius: 50%;
            border: 2px solid #2C3E50;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1;
        }
        
        .dumbbell-eyes {
            display: flex;
            gap: 6px;
            animation: blink 4s infinite;
        }
        
        @keyframes blink {
            0%, 48%, 52%, 100% { 
                transform: scaleY(1);
            }
            50% { 
                transform: scaleY(0.1);
            }
        }
        
        .dumbbell-eye {
            width: 6px;
            height: 8px;
            background: #2C3E50;
            border-radius: 50%;
            position: relative;
            animation: lookAround 6s infinite;
        }
        
        @keyframes lookAround {
            0%, 20% {
                transform: translateX(0px);
            }
            25%, 45% {
                transform: translateX(-2px);
            }
            50%, 70% {
                transform: translateX(2px);
            }
            75%, 100% {
                transform: translateX(0px);
            }
        }
        
        .dumbbell-eye:before {
            content: '';
            position: absolute;
            width: 2px;
            height: 2px;
            background: white;
            border-radius: 50%;
            top: 1px;
            left: 1px;
        }
        
        .dumbbell-mouth {
            position: absolute;
            bottom: 8px;
            left: 50%;
            transform: translateX(-50%);
            width: 12px;
            height: 6px;
            border: 2px solid #2C3E50;
            border-top: none;
            border-radius: 0 0 12px 12px;
            animation: smile 5s infinite;
        }
        
        @keyframes smile {
            0%, 40%, 100% {
                width: 12px;
                height: 6px;
            }
            45%, 95% {
                width: 16px;
                height: 8px;
            }
        }

        /* == A: Per-exercise weight progress == */
        .weight-progress-wrap {
            margin-top: 12px;
            padding: 12px 14px;
            background: rgba(0,0,0,.05);
            border-radius: 12px;
        }
        .weight-progress-wrap .wp-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: #555;
            margin-bottom: 5px;
        }
        .weight-progress-wrap .wp-track {
            height: 10px;
            background: rgba(0,0,0,.10);
            border-radius: 999px;
            overflow: hidden;
            margin-bottom: 8px;
        }
        .weight-progress-wrap [data-wp-bar] {
            height: 100%;
            width: 0%;
            border-radius: 999px;
            transition: width .35s ease, background .35s ease;
        }
        .weight-progress-wrap .wp-inputs {
            display: flex;
            gap: 7px;
            flex-wrap: wrap;
        }
        .weight-progress-wrap .wp-inp {
            flex: 1;
            min-width: 110px;
            padding: 7px 10px;
            border-radius: 10px;
            border: 1px solid rgba(0,0,0,.14);
            background: #fff;
            font-size: 13px;
            color: #333;
        }
        .weight-progress-wrap .wp-goal-inp { width:110px; min-width:110px; flex: 0 0 110px; }
        .weight-progress-wrap .wp-save { padding: 7px 12px; font-size: 13px; }
        .weight-progress-wrap [data-wp-saved] { margin-top:5px; font-size:11px; color:#2ecc71; display:none; }

        /* == B: Bodyweight progress card == */
        #bwProgressCard {
            background: linear-gradient(135deg,#1a1a2e 0%,#16213e 100%);
            border-radius: 16px;
            padding: 18px;
            margin-bottom: 16px;
            color: #fff;
            box-shadow: 0 4px 20px rgba(0,0,0,.18);
        }
        #bwProgressCard .bw-title { font-size:13px; font-weight:700; letter-spacing:.06em; text-transform:uppercase; opacity:.65; margin-bottom:8px; }
        #bwProgressCard .bw-kv   { font-size:14px; opacity:.9; margin-bottom:10px; }
        #bwProgressCard .bw-track { height:10px; background:rgba(255,255,255,.12); border-radius:999px; overflow:hidden; margin-bottom:12px; }
        #bwProgressCard [data-bw-bar] { height:100%; width:0%; border-radius:999px; background:#2ecc71; transition:width .4s ease,background .4s ease; }
        #bwProgressCard .bw-inputs { display:flex; gap:8px; flex-wrap:wrap; }
        #bwProgressCard .bw-inp { flex:1; min-width:110px; padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.18); background:rgba(255,255,255,.08); color:#fff; font-size:13px; }
        #bwProgressCard .bw-inp::placeholder { color:rgba(255,255,255,.4); }
        #bwProgressCard .bw-save-btn { padding:8px 14px; border-radius:10px; background:#2ecc71; color:#fff; border:none; cursor:pointer; font-weight:700; font-size:13px; white-space:nowrap; }
        #bwProgressCard [data-bw-saved] { margin-top:6px; font-size:11px; color:#2ecc71; display:none; }

        /* == C: Music control == */
        #lobbyMusicPanel {
            position:fixed; bottom:52px; right:12px; z-index:9998;
            background:#1a1a2e; color:#fff;
            border-radius:14px; padding:10px 14px;
            font-size:12px; font-family:monospace;
            box-shadow:0 4px 20px rgba(0,0,0,.35);
            min-width:170px; display:none;
        }
        #lobbyMusicPanel .mp-row { display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:6px; }
        #lobbyMusicPanel .mp-label { opacity:.6; font-size:11px; }
        #lobbyMusicPanel .mp-toggle { padding:4px 10px; border-radius:8px; border:1px solid rgba(255,255,255,.22); background:rgba(255,255,255,.07); color:#fff; font-size:11px; cursor:pointer; font-family:monospace; }
        #lobbyMusicPanel input[type=range] { width:80px; accent-color:#2ecc71; }
        #musicEnableBanner {
            position:fixed; bottom:110px; right:12px; z-index:9997;
            background:#2ecc71; color:#fff; border-radius:12px;
            padding:10px 16px; font-size:13px; font-weight:700; cursor:pointer;
            box-shadow:0 4px 16px rgba(46,204,113,.45);
            display:none; animation:popIn .3s ease;
        }
        @keyframes popIn { from{transform:scale(.8);opacity:0} to{transform:scale(1);opacity:1} }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Top Bar -->
        <div class="top-bar" id="topBar">
            <button class="menu-btn" onclick="toggleMenu()">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <div class="app-title" id="topTitle">âš¡ Performance Coach</div>
            <button class="exit-btn" id="exitBtn" onclick="logout()" style="display: none;" title="Exit"></button>
        </div>
        
        <!-- Side Menu -->
        <div class="menu-overlay" onclick="toggleMenu()"></div>
        <div class="side-menu">
            <div class="menu-header">
                <div class="menu-user" id="menuUserName">John Doe</div>
                <div class="menu-role" id="menuUserRole">Trainee</div>
            </div>
            <div class="menu-items">
                <div class="menu-item active" onclick="showPage('traineeDashboardPage')">
                    <span class="menu-icon">
                        <svg width="56" height="56" viewBox="0 0 50 40" style="vertical-align: middle;">
                            <defs>
                                <radialGradient id="weight3d1" cx="30%" cy="30%">
                                    <stop offset="0%" style="stop-color:#27AE60"/>
                                    <stop offset="60%" style="stop-color:#2ECC71"/>
                                    <stop offset="100%" style="stop-color:#1E8449"/>
                                </radialGradient>
                                <filter id="shadow" x="-50%" y="-50%" width="200%" height="200%">
                                    <feGaussianBlur in="SourceAlpha" stdDeviation="1.5"/>
                                    <feOffset dx="1" dy="2"/>
                                    <feComponentTransfer><feFuncA type="linear" slope="0.4"/></feComponentTransfer>
                                    <feMerge><feMergeNode/><feMergeNode in="SourceGraphic"/></feMerge>
                                </filter>
                            </defs>
                            <g filter="url(#shadow)">
                                <rect x="8" y="12" width="10" height="14" rx="2" fill="url(#weight3d1)"/>
                                <ellipse cx="11" cy="15" rx="3" ry="4" fill="white" opacity="0.3"/>
                                <rect x="32" y="12" width="10" height="14" rx="2" fill="url(#weight3d1)"/>
                                <ellipse cx="35" cy="15" rx="3" ry="4" fill="white" opacity="0.3"/>
                                <rect x="16" y="17" width="18" height="5" rx="2.5" fill="#2C3E50"/>
                                <rect x="17" y="18" width="16" height="1.5" rx="0.7" fill="white" opacity="0.2"/>
                                <circle cx="25" cy="19.5" r="8" fill="white" stroke="#2C3E50" stroke-width="1.5"/>
                                <circle cx="23" cy="18" r="1.5" fill="#2C3E50"/>
                                <circle cx="27" cy="18" r="1.5" fill="#2C3E50"/>
                                <path d="M 23 21 Q 25 22.5 27 21" stroke="#2C3E50" stroke-width="1.2" fill="none"/>
                                <!-- 3D Chart bars -->
                                <rect x="13" y="9" width="3" height="5" fill="#27AE60" opacity="0.7"/>
                                <rect x="13.5" y="9.5" width="1" height="2" fill="white" opacity="0.3"/>
                                <rect x="19" y="6" width="3" height="8" fill="#27AE60" opacity="0.7"/>
                                <rect x="19.5" y="6.5" width="1" height="3" fill="white" opacity="0.3"/>
                                <rect x="28" y="7" width="3" height="7" fill="#27AE60" opacity="0.7"/>
                                <rect x="28.5" y="7.5" width="1" height="2.5" fill="white" opacity="0.3"/>
                                <rect x="34" y="10" width="3" height="4" fill="#27AE60" opacity="0.7"/>
                                <rect x="34.5" y="10.5" width="1" height="1.5" fill="white" opacity="0.3"/>
                            </g>
                        </svg>
                    </span>
                    <span class="menu-text">Dashboard</span>
                </div>
                <div class="menu-item" onclick="showPage('program')">
                    <span class="menu-icon">
                        <svg width="56" height="56" viewBox="0 0 50 40" style="vertical-align: middle;">
                            <defs>
                                <radialGradient id="weight3d2" cx="30%" cy="30%">
                                    <stop offset="0%" style="stop-color:#27AE60"/>
                                    <stop offset="60%" style="stop-color:#2ECC71"/>
                                    <stop offset="100%" style="stop-color:#1E8449"/>
                                </radialGradient>
                            </defs>
                            <g filter="url(#shadow)">
                                <rect x="6" y="10" width="12" height="18" rx="3" fill="url(#weight3d2)"/>
                                <ellipse cx="10" cy="14" rx="4" ry="6" fill="white" opacity="0.3"/>
                                <rect x="32" y="10" width="12" height="18" rx="3" fill="url(#weight3d2)"/>
                                <ellipse cx="36" cy="14" rx="4" ry="6" fill="white" opacity="0.3"/>
                                <rect x="16" y="16" width="18" height="6" rx="3" fill="#2C3E50"/>
                                <rect x="17" y="17" width="16" height="2" rx="1" fill="white" opacity="0.25"/>
                                <circle cx="25" cy="19" r="8" fill="white" stroke="#2C3E50" stroke-width="1.5"/>
                                <circle cx="23" cy="18" r="1.5" fill="#2C3E50"/>
                                <circle cx="27" cy="18" r="1.5" fill="#2C3E50"/>
                                <path d="M 23 21 Q 25 22.5 27 21" stroke="#2C3E50" stroke-width="1.2" fill="none"/>
                                <!-- Muscular arms lifting -->
                                <ellipse cx="16" cy="15" rx="3" ry="5" fill="#E8B998" transform="rotate(-25 16 15)"/>
                                <ellipse cx="14" cy="14" rx="2" ry="3" fill="#D4A574" transform="rotate(-25 14 14)"/>
                                <ellipse cx="34" cy="15" rx="3" ry="5" fill="#E8B998" transform="rotate(25 34 15)"/>
                                <ellipse cx="36" cy="14" rx="2" ry="3" fill="#D4A574" transform="rotate(25 36 14)"/>
                            </g>
                        </svg>
                    </span>
                    <span class="menu-text">Weekly Program</span>
                </div>
                <div class="menu-item" onclick="showPage('missions')">
                    <span class="menu-icon">
                        <svg width="56" height="56" viewBox="0 0 50 40" style="vertical-align: middle;">
                            <g filter="url(#shadow)">
                                <rect x="8" y="12" width="10" height="14" rx="2" fill="url(#weight3d1)"/>
                                <ellipse cx="11" cy="15" rx="3" ry="4" fill="white" opacity="0.3"/>
                                <rect x="32" y="12" width="10" height="14" rx="2" fill="url(#weight3d1)"/>
                                <ellipse cx="35" cy="15" rx="3" ry="4" fill="white" opacity="0.3"/>
                                <rect x="16" y="17" width="18" height="5" rx="2.5" fill="#2C3E50"/>
                                <rect x="17" y="18" width="16" height="1.5" rx="0.7" fill="white" opacity="0.2"/>
                                <circle cx="25" cy="19.5" r="8" fill="white" stroke="#2C3E50" stroke-width="1.5"/>
                                <circle cx="23" cy="18" r="1.5" fill="#2C3E50"/>
                                <circle cx="27" cy="18" r="1.5" fill="#2C3E50"/>
                                <path d="M 23 21 Q 25 22.5 27 21" stroke="#2C3E50" stroke-width="1.2" fill="none"/>
                                <!-- 3D Target -->
                                <circle cx="38" cy="12" r="6" fill="#FFEBEE" stroke="#E74C3C" stroke-width="1.5"/>
                                <circle cx="38" cy="12" r="4" fill="#FFCDD2" stroke="#E74C3C" stroke-width="1"/>
                                <circle cx="38" cy="12" r="2" fill="#E74C3C"/>
                                <circle cx="37" cy="11" r="0.8" fill="#FF5252" opacity="0.8"/>
                            </g>
                        </svg>
                    </span>
                    <span class="menu-text">Weekly Missions</span>
                </div>
                <div class="menu-item" onclick="showPage('calls')">
                    <span class="menu-icon">
                        <svg width="56" height="56" viewBox="0 0 50 40" style="vertical-align: middle;">
                            <defs>
                                <radialGradient id="phone3d" cx="30%" cy="30%">
                                    <stop offset="0%" style="stop-color:#5DADE2"/>
                                    <stop offset="60%" style="stop-color:#3498db"/>
                                    <stop offset="100%" style="stop-color:#2980b9"/>
                                </radialGradient>
                            </defs>
                            <g filter="url(#shadow)">
                                <rect x="8" y="12" width="10" height="14" rx="2" fill="url(#weight3d1)"/>
                                <ellipse cx="11" cy="15" rx="3" ry="4" fill="white" opacity="0.3"/>
                                <rect x="32" y="12" width="10" height="14" rx="2" fill="url(#weight3d1)"/>
                                <ellipse cx="35" cy="15" rx="3" ry="4" fill="white" opacity="0.3"/>
                                <rect x="16" y="17" width="18" height="5" rx="2.5" fill="#2C3E50"/>
                                <rect x="17" y="18" width="16" height="1.5" rx="0.7" fill="white" opacity="0.2"/>
                                <circle cx="25" cy="19.5" r="8" fill="white" stroke="#2C3E50" stroke-width="1.5"/>
                                <circle cx="23" cy="18" r="1.5" fill="#2C3E50"/>
                                <circle cx="27" cy="18" r="1.5" fill="#2C3E50"/>
                                <path d="M 23 21 Q 25 22.5 27 21" stroke="#2C3E50" stroke-width="1.2" fill="none"/>
                                <!-- 3D Phone -->
                                <rect x="33" y="14" width="7" height="11" rx="1.5" fill="url(#phone3d)" stroke="#2980b9" stroke-width="1"/>
                                <rect x="34" y="15" width="5" height="7" rx="0.5" fill="#34495E" opacity="0.7"/>
                                <circle cx="36.5" cy="23.5" r="0.8" fill="white" opacity="0.8"/>
                                <rect x="33.5" y="14.5" width="2" height="4" rx="0.5" fill="white" opacity="0.25"/>
                            </g>
                        </svg>
                    </span>
                    <span class="menu-text">Schedule Calls</span>
                </div>
                <div class="menu-item" onclick="showPage('notifications')" id="notificationsMenuItem" style="display: none;">
                    <span class="menu-icon">
                        <svg width="56" height="56" viewBox="0 0 50 40" style="vertical-align: middle;">
                            <g filter="url(#shadow)">
                                <rect x="8" y="12" width="10" height="14" rx="2" fill="url(#weight3d1)"/>
                                <ellipse cx="11" cy="15" rx="3" ry="4" fill="white" opacity="0.3"/>
                                <rect x="32" y="12" width="10" height="14" rx="2" fill="url(#weight3d1)"/>
                                <ellipse cx="35" cy="15" rx="3" ry="4" fill="white" opacity="0.3"/>
                                <rect x="16" y="17" width="18" height="5" rx="2.5" fill="#2C3E50"/>
                                <rect x="17" y="18" width="16" height="1.5" rx="0.7" fill="white" opacity="0.2"/>
                                <circle cx="25" cy="19.5" r="8" fill="white" stroke="#2C3E50" stroke-width="1.5"/>
                                <circle cx="23" cy="18" r="1.5" fill="#2C3E50"/>
                                <circle cx="27" cy="18" r="1.5" fill="#2C3E50"/>
                                <path d="M 23 21 Q 25 22.5 27 21" stroke="#2C3E50" stroke-width="1.2" fill="none"/>
                                <!-- 3D Message bubble -->
                                <rect x="33" y="11" width="11" height="8" rx="2" fill="url(#phone3d)"/>
                                <rect x="34" y="12" width="3" height="1" rx="0.5" fill="white" opacity="0.7"/>
                                <rect x="34" y="14" width="7" height="1" rx="0.5" fill="white" opacity="0.5"/>
                                <rect x="34" y="16" width="5" height="1" rx="0.5" fill="white" opacity="0.5"/>
                                <path d="M 36 19 L 38 21 L 40 19" fill="url(#phone3d)"/>
                                <ellipse cx="35" cy="12" rx="2" ry="3" fill="white" opacity="0.2"/>
                            </g>
                        </svg>
                    </span>
                    <span class="menu-text">SMS Notifications</span>
                </div>
                <div class="menu-item" onclick="showPage('trainees')" id="traineesMenuItem" style="display: none;">
                    <span class="menu-icon">
                        <svg width="56" height="56" viewBox="0 0 50 40" style="vertical-align: middle;">
                            <g filter="url(#shadow)">
                                <rect x="8" y="12" width="10" height="14" rx="2" fill="url(#weight3d1)"/>
                                <ellipse cx="11" cy="15" rx="3" ry="4" fill="white" opacity="0.3"/>
                                <rect x="32" y="12" width="10" height="14" rx="2" fill="url(#weight3d1)"/>
                                <ellipse cx="35" cy="15" rx="3" ry="4" fill="white" opacity="0.3"/>
                                <rect x="16" y="17" width="18" height="5" rx="2.5" fill="#2C3E50"/>
                                <rect x="17" y="18" width="16" height="1.5" rx="0.7" fill="white" opacity="0.2"/>
                                <circle cx="25" cy="19.5" r="8" fill="white" stroke="#2C3E50" stroke-width="1.5"/>
                                <circle cx="23" cy="18" r="1.5" fill="#2C3E50"/>
                                <circle cx="27" cy="18" r="1.5" fill="#2C3E50"/>
                                <path d="M 23 21 Q 25 22.5 27 21" stroke="#2C3E50" stroke-width="1.2" fill="none"/>
                                <!-- 3D People icons -->
                                <circle cx="12" cy="8" r="2.5" fill="url(#phone3d)"/>
                                <circle cx="11" cy="7" r="1" fill="white" opacity="0.4"/>
                                <circle cx="38" cy="8" r="2.5" fill="url(#phone3d)"/>
                                <circle cx="37" cy="7" r="1" fill="white" opacity="0.4"/>
                                <circle cx="25" cy="5" r="2.5" fill="url(#phone3d)"/>
                                <circle cx="24" cy="4" r="1" fill="white" opacity="0.4"/>
                            </g>
                        </svg>
                    </span>
                    <span class="menu-text">Manage Trainees</span>
                </div>
                <div class="menu-item" onclick="showPage('chat')">
                    <span class="menu-icon">
                        <svg width="56" height="56" viewBox="0 0 50 40" style="vertical-align: middle;">
                            <g filter="url(#shadow)">
                                <rect x="8" y="12" width="10" height="14" rx="2" fill="url(#weight3d1)"/>
                                <ellipse cx="11" cy="15" rx="3" ry="4" fill="white" opacity="0.3"/>
                                <rect x="32" y="12" width="10" height="14" rx="2" fill="url(#weight3d1)"/>
                                <ellipse cx="35" cy="15" rx="3" ry="4" fill="white" opacity="0.3"/>
                                <rect x="16" y="17" width="18" height="5" rx="2.5" fill="#2C3E50"/>
                                <rect x="17" y="18" width="16" height="1.5" rx="0.7" fill="white" opacity="0.2"/>
                                <circle cx="25" cy="19.5" r="8" fill="white" stroke="#2C3E50" stroke-width="1.5"/>
                                <circle cx="23" cy="18" r="1.5" fill="#2C3E50"/>
                                <circle cx="27" cy="18" r="1.5" fill="#2C3E50"/>
                                <path d="M 23 21 Q 25 22.5 27 21" stroke="#2C3E50" stroke-width="1.2" fill="none"/>
                                <!-- 3D Speech bubble -->
                                <rect x="32" y="9" width="13" height="9" rx="2.5" fill="white" stroke="#2C3E50" stroke-width="1.5"/>
                                <rect x="33" y="11" width="5" height="1" rx="0.5" fill="#95a5a6"/>
                                <rect x="33" y="13" width="8" height="1" rx="0.5" fill="#95a5a6"/>
                                <rect x="33" y="15" width="6" height="1" rx="0.5" fill="#95a5a6"/>
                                <path d="M 34 18 L 32 20 L 36 18" fill="white" stroke="#2C3E50" stroke-width="1.5"/>
                                <ellipse cx="35" cy="10" rx="3" ry="2" fill="white" opacity="0.6"/>
                            </g>
                        </svg>
                    </span>
                    <span class="menu-text">Chat</span>
                </div>
            </div>
        </div>
        
        <!-- Content Area -->
        <div class="content">
            <!-- SIGNUP PAGE -->
            <div class="page active" id="signup">
                <div class="card" style="text-align: center; margin-top: 40px;">
                    <!-- 3D Bubble Buddy Illustration -->
                    <svg width="160" height="120" viewBox="0 0 160 120" style="margin: 0 auto 20px;">
                        <defs>
                            <!-- 3D Gradients for depth -->
                            <radialGradient id="weight3D" cx="30%" cy="30%">
                                <stop offset="0%" style="stop-color:#27AE60;stop-opacity:1" />
                                <stop offset="50%" style="stop-color:#2ECC71;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#1E8449;stop-opacity:1" />
                            </radialGradient>
                            <radialGradient id="bar3D" cx="30%" cy="30%">
                                <stop offset="0%" style="stop-color:#34495E;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#2C3E50;stop-opacity:1" />
                            </radialGradient>
                            <radialGradient id="face3D" cx="35%" cy="30%">
                                <stop offset="0%" style="stop-color:#ffffff;stop-opacity:1" />
                                <stop offset="70%" style="stop-color:#f5f5f5;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#e8e8e8;stop-opacity:1" />
                            </radialGradient>
                            <!-- Shadow filter -->
                            <filter id="shadow3D" x="-50%" y="-50%" width="200%" height="200%">
                                <feGaussianBlur in="SourceAlpha" stdDeviation="3"/>
                                <feOffset dx="2" dy="4" result="offsetblur"/>
                                <feComponentTransfer>
                                    <feFuncA type="linear" slope="0.3"/>
                                </feComponentTransfer>
                                <feMerge>
                                    <feMergeNode/>
                                    <feMergeNode in="SourceGraphic"/>
                                </feMerge>
                            </filter>
                        </defs>
                        
                        <g filter="url(#shadow3D)">
                            <!-- Left Weight with 3D effect -->
                            <ellipse cx="40" cy="52" rx="14" ry="22" fill="url(#weight3D)"/>
                            <rect x="30" y="40" width="20" height="35" rx="4" fill="url(#weight3D)" stroke="#1E8449" stroke-width="2"/>
                            <!-- Highlight on left weight -->
                            <ellipse cx="35" cy="48" rx="6" ry="8" fill="white" opacity="0.3"/>
                            
                            <!-- Right Weight with 3D effect -->
                            <ellipse cx="120" cy="52" rx="14" ry="22" fill="url(#weight3D)"/>
                            <rect x="110" y="40" width="20" height="35" rx="4" fill="url(#weight3D)" stroke="#1E8449" stroke-width="2"/>
                            <!-- Highlight on right weight -->
                            <ellipse cx="115" cy="48" rx="6" ry="8" fill="white" opacity="0.3"/>
                            
                            <!-- Bar with 3D cylindrical effect -->
                            <rect x="48" y="50" width="64" height="14" rx="7" fill="url(#bar3D)" stroke="#2C3E50" stroke-width="2"/>
                            <!-- Bar highlight -->
                            <rect x="50" y="52" width="60" height="4" rx="2" fill="white" opacity="0.2"/>
                            
                            <!-- Face Circle with 3D sphere effect -->
                            <circle cx="80" cy="57" r="22" fill="url(#face3D)" stroke="#2C3E50" stroke-width="3"/>
                            
                            <!-- Eyes with depth -->
                            <g>
                                <!-- Left eye -->
                                <ellipse cx="72" cy="54" rx="3.5" ry="5" fill="#2C3E50"/>
                                <circle cx="73" cy="52" r="1.5" fill="white" opacity="0.8"/>
                                <!-- Right eye -->
                                <ellipse cx="88" cy="54" rx="3.5" ry="5" fill="#2C3E50"/>
                                <circle cx="89" cy="52" r="1.5" fill="white" opacity="0.8"/>
                            </g>
                            
                            <!-- Smile with dimension -->
                            <path d="M 70 62 Q 80 67 90 62" stroke="#2C3E50" stroke-width="3" fill="none" stroke-linecap="round"/>
                            <!-- Smile highlight -->
                            <path d="M 72 62 Q 80 66 88 62" stroke="white" stroke-width="1" fill="none" opacity="0.3" stroke-linecap="round"/>
                        </g>
                        
                        <!-- 3D Floating bubbles with depth -->
                        <g opacity="0.6">
                            <circle cx="50" cy="28" r="5" fill="#2ECC71" filter="url(#shadow3D)">
                                <animate attributeName="cy" values="28;22;28" dur="2.5s" repeatCount="indefinite"/>
                            </circle>
                            <circle cx="52" cy="29" r="2" fill="white" opacity="0.5"/>
                            
                            <circle cx="110" cy="24" r="4" fill="#27AE60" filter="url(#shadow3D)">
                                <animate attributeName="cy" values="24;18;24" dur="3s" repeatCount="indefinite"/>
                            </circle>
                            <circle cx="111" cy="25" r="1.5" fill="white" opacity="0.5"/>
                            
                            <circle cx="60" cy="85" r="4.5" fill="#2ECC71" filter="url(#shadow3D)">
                                <animate attributeName="cy" values="85;90;85" dur="2.8s" repeatCount="indefinite"/>
                            </circle>
                            <circle cx="61" cy="86" r="1.8" fill="white" opacity="0.5"/>
                            
                            <circle cx="100" cy="88" r="4" fill="#27AE60" filter="url(#shadow3D)">
                                <animate attributeName="cy" values="88;93;88" dur="3.2s" repeatCount="indefinite"/>
                            </circle>
                            <circle cx="101" cy="89" r="1.5" fill="white" opacity="0.5"/>
                            
                            <circle cx="80" cy="20" r="3.5" fill="#2ECC71" filter="url(#shadow3D)">
                                <animate attributeName="cy" values="20;15;20" dur="2.2s" repeatCount="indefinite"/>
                            </circle>
                            <circle cx="81" cy="21" r="1.3" fill="white" opacity="0.5"/>
                        </g>
                    </svg>
                    <div class="card-title" style="font-size: 2em; margin-bottom: 10px;">Welcome to Performance Coach!</div>
                    <p style="color: #7f8c8d; font-size: 1.1em; margin-bottom: 30px;">Choose how you want to join</p>
                    
                    <div style="display: grid; gap: 15px; margin-bottom: 30px;">
                        <button class="btn btn-primary" onclick="selectSignupType('trainee')" style="font-size: 1.2em; padding: 20px;">
                            <div style="font-size: 2em; margin-bottom: 5px;">ðŸ‘¤</div>
                            <div>I'm a Trainee</div>
                            <div style="font-size: 0.8em; opacity: 0.9; margin-top: 5px;">Get coached and track your fitness</div>
                        </button>
                        
                        <button class="btn btn-primary" onclick="selectSignupType('coach')" style="font-size: 1.2em; padding: 20px; background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);">
                            <div style="font-size: 2em; margin-bottom: 5px;">ðŸŽ“</div>
                            <div>I'm a Coach</div>
                            <div style="font-size: 0.8em; opacity: 0.9; margin-top: 5px;">Manage and coach your trainees</div>
                        </button>
                    </div>
                    
                    <div style="padding-top: 20px; border-top: 1px solid #E8F5E9;">
                        <p style="color: #7f8c8d; font-size: 0.9em; margin-bottom: 10px;">Already have an account?</p>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <button class="btn btn-outline" onclick="showTraineeLogin()">
                                ðŸ‘¤ Trainee Login
                            </button>
                            <button class="btn btn-outline" onclick="showCoachLogin()">
                                ðŸŽ“ Coach Login
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- TRAINEE SIGNUP PAGE -->
            <div class="page" id="traineeSignup">
                <div class="card" style="margin-top: 40px;">
                    <button class="btn btn-secondary btn-small" onclick="showPage('signup')" style="margin-bottom: 20px;">
                        â† Back
                    </button>
                    
                    <div style="text-align: center; margin-bottom: 30px;">
                        <div style="font-size: 3em; margin-bottom: 10px;">ðŸ‘¤</div>
                        <div class="card-title" style="font-size: 1.8em;">Trainee Sign Up</div>
                        <p style="color: #7f8c8d;">Start your fitness journey today!</p>
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">Full Name</label>
                        <input type="text" class="input-field" id="traineeSignupName" placeholder="Enter your name">
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">Email</label>
                        <input type="email" class="input-field" id="traineeSignupEmail" placeholder="your@email.com">
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">Phone Number</label>
                        <input type="tel" class="input-field" id="traineeSignupPhone" placeholder="+1 (555) 123-4567">
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">Create Password</label>
                        <input type="password" class="input-field" id="traineeSignupPassword" placeholder="Choose a password">
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">Fitness Goal</label>
                        <select class="input-field" id="traineeSignupGoal">
                            <option value="">Select your goal...</option>
                            <option value="muscle">Build Muscle ðŸ’ª</option>
                            <option value="lose">Lose Weight ðŸ”¥</option>
                            <option value="strength">Get Stronger ðŸ‹ï¸</option>
                            <option value="athletic">Athletic Performance âš¡</option>
                            <option value="general">General Fitness ðŸŒŸ</option>
                        </select>
                    </div>
                    
                    <div id="traineeSignupError" style="display:none;margin-top:12px;padding:10px 14px;background:#FFE6E6;border-left:4px solid #E74C3C;border-radius:8px;color:#C0392B;font-size:0.9em;font-weight:600;"></div>
                    
                    <button id="traineeSignupSubmitBtn" type="button" class="btn btn-primary" style="margin-top: 20px; font-size: 1.1em;">
                        ðŸš€ Start My Journey
                    </button>
                </div>
            </div>
            
            <!-- COACH SIGNUP PAGE -->
            <div class="page" id="coachSignup">
                <div class="card" style="margin-top: 40px;">
                    <button class="btn btn-secondary btn-small" onclick="showPage('signup')" style="margin-bottom: 20px;">
                        â† Back
                    </button>
                    
                    <div style="text-align: center; margin-bottom: 30px;">
                        <div style="font-size: 3em; margin-bottom: 10px;">ðŸŽ“</div>
                        <div class="card-title" style="font-size: 1.8em;">Coach Sign Up</div>
                        <p style="color: #7f8c8d;">Start coaching and managing trainees</p>
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">Full Name</label>
                        <input type="text" class="input-field" id="coachSignupName" placeholder="Enter your name">
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">Email</label>
                        <input type="email" class="input-field" id="coachSignupEmail" placeholder="coach@example.com">
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">Phone Number</label>
                        <input type="tel" class="input-field" id="coachSignupPhone" placeholder="+1 (555) 123-4567">
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">Create Access Code (4 digits)</label>
                        <input type="password" class="input-field" id="coachSignupCode" placeholder="1234" maxlength="4">
                    </div>
                    
                    <div id="coachSignupError" style="display:none;margin-top:12px;padding:10px 14px;background:#FFE6E6;border-left:4px solid #E74C3C;border-radius:8px;color:#C0392B;font-size:0.9em;font-weight:600;"></div>
                    
                    <button class="btn btn-primary" onclick="completeCoachSignup()" style="margin-top: 20px; font-size: 1.1em; background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);">
                        ðŸŽ“ Start Coaching
                    </button>
                </div>
            </div>
            
            <!-- TRAINEE LOGIN PAGE -->
            <div class="page" id="traineeLoginPage">
                <div class="card" style="text-align: center; margin-top: 60px;">
                    <button class="btn btn-secondary btn-small" onclick="showPage('signup')" style="position: absolute; top: 20px; left: 20px;">
                        â† Back
                    </button>
                    
                    <div style="font-size: 3em; margin-bottom: 20px;">ðŸ‘¤</div>
                    <div class="card-title" style="font-size: 1.8em; margin-bottom: 10px;">Trainee Login</div>
                    <p style="color: #7f8c8d; margin-bottom: 30px;">Welcome back! Let's continue your journey</p>
                    
                    <div class="input-group" style="text-align: left;">
                        <label class="input-label">Email</label>
                        <input type="email" class="input-field" id="traineeLoginEmail" placeholder="your@email.com">
                    </div>
                    
                    <div class="input-group" style="text-align: left;">
                        <label class="input-label">Password</label>
                        <input type="password" class="input-field" id="traineeLoginPassword" placeholder="Enter your password" onkeypress="if(event.key==='Enter') loginAsTrainee()">
                    </div>
                    
                    <div id="traineeLoginError" style="display:none;margin-top:12px;padding:10px 14px;background:#FFE6E6;border-left:4px solid #E74C3C;border-radius:8px;color:#C0392B;font-size:0.9em;font-weight:600;"></div>
                    
                    <button type="button" class="btn btn-primary" onclick="loginAsTrainee()" style="margin-top: 12px; font-size: 1.1em; width: 100%;">
                        ðŸ” Login
                    </button>
                    

                    
                    <p style="color: #7f8c8d; font-size: 0.9em; margin-top: 20px;">
                        Don't have an account? <a href="#" onclick="showPage('signup'); return false;" style="color: #2ECC71; font-weight: 600;">Sign Up</a>
                    </p>
                </div>
            </div>
            
            <!-- COACH LOGIN PAGE -->
            <div class="page" id="coachLoginPage">
                <div class="card" style="text-align: center; margin-top: 60px;">
                    <button class="btn btn-secondary btn-small" onclick="showPage('signup')" style="position: absolute; top: 20px; left: 20px;">
                        â† Back
                    </button>
                    
                    <div style="font-size: 3em; margin-bottom: 20px;">ðŸŽ“</div>
                    <div class="card-title" style="font-size: 1.8em; margin-bottom: 10px;">Coach Login</div>
                    <p style="color: #7f8c8d; margin-bottom: 30px;">Access your coaching dashboard</p>
                    
                    <div class="input-group" style="text-align: left;">
                        <label class="input-label">Coach Email</label>
                        <input type="email" class="input-field" id="coachLoginEmail" placeholder="coach@example.com" onkeypress="if(event.key==='Enter') loginAsCoach()">
                    </div>
                    
                    <div class="input-group" style="text-align: left;">
                        <label class="input-label">Access Code</label>
                        <input type="password" class="input-field" id="coachLoginCode" placeholder="Enter 4-digit code" maxlength="4" onkeypress="if(event.key==='Enter') loginAsCoach()">
                    </div>
                    
                    <div id="coachLoginError" style="display:none;margin-top:12px;padding:10px 14px;background:#FFE6E6;border-left:4px solid #E74C3C;border-radius:8px;color:#C0392B;font-size:0.9em;font-weight:600;"></div>
                    
                    <button type="button" class="btn btn-primary" onclick="loginAsCoach()" style="margin-top: 12px; font-size: 1.1em; width: 100%; background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);">
                        ðŸŽ“ Login as Coach
                    </button>
                    

                    
                    <p style="color: #7f8c8d; font-size: 0.9em; margin-top: 20px;">
                        <a href="#" onclick="showPage('signup'); return false;" style="color: #2ECC71; font-weight: 600;">â† Back to Sign Up</a>
                    </p>
                </div>
            </div>
            
            <!-- COACH DASHBOARD PAGE -->
            <!-- DASHBOARD PAGE -->
            <div class="page" id="traineeDashboardPage">
                <div class="card" style="background: linear-gradient(135deg, #E8F5E9 0%, #A9F5C1 100%); border-left: 4px solid #2ECC71;">
                    <div style="font-size: 1.8em; font-weight: bold; color: #1E8449; margin-bottom: 5px;">
                        Hi, <span id="userGreetingName">John</span>! ðŸ‘‹
                    </div>
                    <div style="color: #7f8c8d; font-size: 1em;">
                        Ready to crush today's goals?
                    </div>
                </div>
                
                <!-- B: Bodyweight Progress Card -->
                <div id="bwProgressCard">
                    <div class="bw-title">Bodyweight Progress</div>
                    <div class="bw-kv" id="bwKV">Current: - kg  |  Goal: - kg</div>
                    <div class="bw-track"><div data-bw-bar></div></div>
                    <div class="bw-inputs">
                        <input class="bw-inp" id="bwCurInput"  type="number" min="0" step="0.1" placeholder="Current kg">
                        <input class="bw-inp" id="bwGoalInput" type="number" min="0" step="0.1" placeholder="Goal kg">
                        <button class="bw-save-btn" type="button" onclick="saveBodyweight()">Save</button>
                    </div>
                    <div data-bw-saved id="bwSavedMsg">Saved</div>
                </div>

                <div class="card">
                    <div class="card-title">Performance Score</div>
                    <div class="score-circle" id="scoreCircle">
                        <div class="score-ring"></div>
                        <div class="score-value" id="scoreValue">85</div>
                        <div class="score-label">/ 100</div>
                    </div>
                    <div class="score-status status-track" id="scoreStatus">
                        âœ… On Track
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-title">This Week</div>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon">ðŸ‹ï¸</div>
                            <div class="stat-value" id="workoutsCompleted">3</div>
                            <div class="stat-label">Workouts Done</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">ðŸŽ</div>
                            <div class="stat-value" id="nutritionScore">8</div>
                            <div class="stat-label">Nutrition Score</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">ðŸ˜´</div>
                            <div class="stat-value" id="sleepAvg">7.5</div>
                            <div class="stat-label">Hours Sleep</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">ðŸ”¥</div>
                            <div class="stat-value">12</div>
                            <div class="stat-label">Day Streak</div>
                        </div>
                    </div>
                </div>
                
                <div class="mission-card">
                    <div class="mission-title">ðŸ“‹ THIS WEEK'S MISSION</div>
                    <div class="mission-text" id="currentMission">Eat 180g protein every day</div>
                    <button class="btn btn-outline" onclick="showPage('missions')">
                        Rate Your Progress â†’
                    </button>
                </div>
            </div>
            
            <!-- COACH DASHBOARD PAGE -->
            <div class="page" id="coachDashboardPage">
                <div class="card" style="background: linear-gradient(135deg, #E7F3FF 0%, #A9D9FF 100%); border-left: 4px solid #3498db;">
                    <div style="font-size: 1.8em; font-weight: bold; color: #2980b9; margin-bottom: 5px;">
                        Coach Dashboard ðŸŽ“
                    </div>
                    <div style="color: #7f8c8d; font-size: 1em;">
                        Manage all your trainees in one place
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <button class="btn btn-primary" onclick="showPage('trainees')" style="font-size: 1em; padding: 20px;">
                        <div style="font-size: 2em; margin-bottom: 5px;">ðŸ‘¥</div>
                        <div>All Trainees</div>
                    </button>
                    <button class="btn btn-primary" onclick="showPage('chat')" style="font-size: 1em; padding: 20px;">
                        <div style="font-size: 2em; margin-bottom: 5px;">ðŸ’¬</div>
                        <div>Messages</div>
                    </button>
                </div>
                
                <div class="card">
                    <div class="card-title">ðŸ“Š Overview</div>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon">ðŸ‘¥</div>
                            <div class="stat-value" id="coachTotalTrainees">5</div>
                            <div class="stat-label">Total Trainees</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">â­</div>
                            <div class="stat-value" id="coachActiveTrainees">4</div>
                            <div class="stat-label">Active This Week</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">ðŸ’¬</div>
                            <div class="stat-value" id="coachUnreadMessages">3</div>
                            <div class="stat-label">Unread Messages</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">ðŸ†</div>
                            <div class="stat-value" id="coachAvgScore">82</div>
                            <div class="stat-label">Avg Score</div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-title">ðŸŽ¯ Quick Actions</div>
                    <div style="display: grid; gap: 10px;">
                        <button class="btn btn-outline" onclick="showPage('notifications')">
                            ðŸ“± Send SMS to All Trainees
                        </button>
                        <button class="btn btn-outline" onclick="showAddTraineeModal()">
                            âž• Add New Trainee
                        </button>
                        <button class="btn btn-outline" onclick="showPage('calls')">
                            ðŸ“ž Manage Call Schedule
                        </button>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-title">âš ï¸ Needs Attention</div>
                    <div id="coachAttentionList">
                        <div style="background: #FFF3CD; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #F39C12; cursor: pointer;" onclick="switchTrainee(2); showPage('trainees');">
                            <div style="font-weight: 600; color: #856404; margin-bottom: 5px;">Sarah Johnson</div>
                            <div style="font-size: 0.9em; color: #2C3E50;">Score dropped to 68 â€¢ Missing 2 workouts</div>
                        </div>
                        <div style="background: #F8D7DA; padding: 15px; border-radius: 8px; border-left: 4px solid #E74C3C; cursor: pointer;" onclick="switchTrainee(3); showPage('trainees');">
                            <div style="font-weight: 600; color: #721C24; margin-bottom: 5px;">Mike Chen</div>
                            <div style="font-size: 0.9em; color: #2C3E50;">No activity for 5 days â€¢ Score: 45</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- PROGRAM PAGE -->
            <div class="page" id="program">
                <div class="card">
                    <div class="card-title">Weekly Training Program</div>
                    <p style="color: #7f8c8d; margin-bottom: 20px;">Tap any day to view details</p>
                    
                    <div id="trainingDaysList"></div>
                    
                    <button class="btn btn-primary" id="addDayBtn" onclick="showAddDayModal()" style="display: none; margin-top: 15px;">
                        âž• Add New Day
                    </button>
                </div>
            </div>
            
            <!-- DAY DETAIL PAGE -->
            <div class="page" id="dayDetail">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <div>
                            <div style="font-size: 2.5em; font-weight: bold; color: #1E8449;" id="detailDayLetter">B</div>
                            <div style="font-size: 1.2em; font-weight: 600; color: #2C3E50;" id="detailDayTitle">Lower Body</div>
                        </div>
                        <div>
                            <button class="btn btn-outline btn-small" id="editDayNameBtn" onclick="editDayName()" style="display: none;">
                                âœï¸ Edit
                            </button>
                        </div>
                    </div>
                    
                    <!-- Trainer Note for the Day -->
                    <div id="trainerNoteSection"></div>
                    
                    <div id="exercisesList"></div>
                    
                    <button class="btn btn-primary" id="addExerciseBtn" onclick="showAddExerciseModal()" style="display: none; margin-top: 15px;">
                        âž• Add Exercise
                    </button>
                    
                    <button class="btn btn-primary" id="markDayCompleteBtn" onclick="toggleDayComplete()" style="margin-top: 15px;">
                        Mark as Complete
                    </button>
                </div>
            </div>
            
            <!-- MISSIONS PAGE -->
            <div class="page" id="missions">
                <div class="card">
                    <div class="card-title">Weekly Mission</div>
                    <div class="mission-card">
                        <div class="mission-title">ðŸŽ¯ NUTRITION MISSION</div>
                        <div class="mission-text" id="missionText">Eat 180g protein every day</div>
                        
                        <div class="slider-container">
                            <div class="slider-value" id="missionRating">7</div>
                            <div class="slider-labels">
                                <span>ðŸ˜” Poor</span>
                                <span>ðŸ˜Š Perfect</span>
                            </div>
                            <input type="range" min="1" max="10" value="7" class="slider" id="missionSlider" oninput="updateMissionRating(this.value)">
                        </div>
                        
                        <button class="btn btn-primary" onclick="saveMissionRating()" style="margin-top: 20px;">
                            Save Rating
                        </button>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-title">Sleep Tracking</div>
                    <div class="input-group">
                        <label class="input-label">Average Sleep (hours per night)</label>
                        <input type="number" class="input-field" id="sleepInput" placeholder="7.5" step="0.5" min="0" max="12" value="7.5">
                    </div>
                    <button class="btn btn-primary" onclick="saveSleep()">
                        Update Sleep
                    </button>
                </div>
                
                <div class="card" id="editMissionsCard" style="display: none;">
                    <div class="card-title">âœï¸ Coach Controls</div>
                    <div class="input-group">
                        <label class="input-label">Edit Mission Text</label>
                        <input type="text" class="input-field" id="editMissionInput" placeholder="Eat 180g protein every day">
                    </div>
                    <button class="btn btn-primary" onclick="updateMission()">
                        Update Mission
                    </button>
                </div>
            </div>
            
            
            <!-- SCHEDULE CALLS PAGE -->
            <div class="page" id="calls">
                <div class="card">
                    <div class="card-title">ðŸ“ž Schedule Calls</div>
                    <p style="color: #7f8c8d; margin-bottom: 20px;" id="callsDescription">Book your weekly call with the coach</p>
                    
                    <div id="callSlotsContainer"></div>
                    
                    <button class="btn btn-primary" id="addSlotBtn" onclick="showAddSlotModal()" style="display: none; margin-top: 15px;">
                        âž• Add Time Slot
                    </button>
                </div>
                
                <div class="card" id="bookedCallCard" style="display: none;">
                    <div class="card-title">âœ… Your Booked Call</div>
                    <div style="background: #E8F5E9; padding: 20px; border-radius: 12px; border-left: 4px solid #2ECC71;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 1.2em; font-weight: bold; color: #1E8449; margin-bottom: 5px;" id="bookedTime"></div>
                                <div style="color: #7f8c8d; font-size: 0.9em;" id="bookedDate"></div>
                            </div>
                            <button class="btn btn-danger btn-small" onclick="cancelCall()">Cancel</button>
                        </div>
                    </div>
                </div>
            </div>
            
            
            <!-- SMS NOTIFICATIONS PAGE (Coach Only) -->
            <div class="page" id="notifications">
                <div class="card">
                    <div class="card-title">ðŸ“± SMS Notifications</div>
                    <p style="color: #7f8c8d; margin-bottom: 20px;">Send automated motivational messages to trainees</p>
                    
                    <div id="smsScheduleList"></div>
                    
                    <button class="btn btn-primary" onclick="showAddSMSModal()" style="margin-top: 15px;">
                        âž• Create New SMS Schedule
                    </button>
                </div>
                
                <div class="card">
                    <div class="card-title">ðŸŽ‰ Milestone Messages</div>
                    <p style="color: #7f8c8d; margin-bottom: 15px; font-size: 0.9em;">Automatic congratulations when trainees hit milestones</p>
                    
                    <div style="background: #E8F5E9; padding: 15px; border-radius: 12px; margin-bottom: 10px; border-left: 4px solid #2ECC71;">
                        <div style="font-weight: 600; color: #1E8449; margin-bottom: 5px;">ðŸ”¥ Workout Streak Milestones</div>
                        <div style="font-size: 0.9em; color: #2C3E50;">
                            <div style="margin: 5px 0;">â€¢ 7 days: "Amazing! One week streak! ðŸ”¥"</div>
                            <div style="margin: 5px 0;">â€¢ 14 days: "Two weeks of consistency! You're unstoppable! ðŸ’ª"</div>
                            <div style="margin: 5px 0;">â€¢ 30 days: "ONE MONTH STREAK! Incredible dedication! ðŸ†"</div>
                        </div>
                    </div>
                    
                    <div style="background: #FFF3CD; padding: 15px; border-radius: 12px; margin-bottom: 10px; border-left: 4px solid #F39C12;">
                        <div style="font-weight: 600; color: #856404; margin-bottom: 5px;">â­ Performance Score Milestones</div>
                        <div style="font-size: 0.9em; color: #2C3E50;">
                            <div style="margin: 5px 0;">â€¢ First 90+: "ELITE performance! You're in the top tier! ðŸŒŸ"</div>
                            <div style="margin: 5px 0;">â€¢ 5 weeks 85+: "Consistent excellence! Keep it up! ðŸŽ¯"</div>
                        </div>
                    </div>
                    
                    <div style="background: #E7F3FF; padding: 15px; border-radius: 12px; border-left: 4px solid #2196F3;">
                        <div style="font-weight: 600; color: #1976D2; margin-bottom: 5px;">ðŸ’¯ Perfect Week</div>
                        <div style="font-size: 0.9em; color: #2C3E50;">
                            <div style="margin: 5px 0;">â€¢ All workouts + 9+ nutrition: "PERFECT WEEK! You crushed it! ðŸŽŠ"</div>
                        </div>
                    </div>
                </div>
            </div>
            
            
            <!-- TRAINEES MANAGEMENT PAGE (Coach Only) -->
            <div class="page" id="trainees">
                <div class="card">
                    <div class="card-title">ðŸ‘¥ Manage Trainees</div>
                    <p style="color: #7f8c8d; margin-bottom: 20px;">Switch between trainees to view and edit their programs</p>
                    
                    <div id="currentTraineeCard" style="background: linear-gradient(135deg, #2ECC71 0%, #27AE60 100%); padding: 20px; border-radius: 12px; margin-bottom: 20px; color: white;">
                        <div style="font-size: 0.85em; opacity: 0.9; margin-bottom: 5px;">Currently Managing:</div>
                        <div style="font-size: 1.5em; font-weight: bold;" id="currentTraineeName">John Doe</div>
                        <div style="font-size: 0.9em; margin-top: 10px; display: flex; justify-content: space-between; align-items: center;">
                            <span id="currentTraineeStats">3/5 workouts â€¢ Score: 85</span>
                            <button class="btn btn-secondary btn-small" onclick="viewTraineeDashboard()" style="background: white; color: #2ECC71;">
                                View Dashboard â†’
                            </button>
                        </div>
                    </div>
                    
                    <div id="traineesList"></div>
                    
                    <button class="btn btn-primary" onclick="showAddTraineeModal()" style="margin-top: 15px;">
                        âž• Add New Trainee
                    </button>
                </div>
                
                <div class="card">
                    <div class="card-title">ðŸ“Š Quick Stats</div>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon">ðŸ‘¥</div>
                            <div class="stat-value" id="totalTrainees">5</div>
                            <div class="stat-label">Total Trainees</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">â­</div>
                            <div class="stat-value" id="activeTrainees">4</div>
                            <div class="stat-label">Active This Week</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">ðŸ†</div>
                            <div class="stat-value" id="avgScore">82</div>
                            <div class="stat-label">Avg Score</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">ðŸ“ž</div>
                            <div class="stat-value" id="bookedCalls">3</div>
                            <div class="stat-label">Calls Booked</div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-title">âš ï¸ Need Attention</div>
                    <div id="attentionList">
                        <div style="background: #FFF3CD; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #F39C12;">
                            <div style="font-weight: 600; color: #856404; margin-bottom: 5px;">Sarah Johnson</div>
                            <div style="font-size: 0.9em; color: #2C3E50;">Score dropped to 68 â€¢ Missing 2 workouts</div>
                        </div>
                        <div style="background: #F8D7DA; padding: 15px; border-radius: 8px; border-left: 4px solid #E74C3C;">
                            <div style="font-weight: 600; color: #721C24; margin-bottom: 5px;">Mike Chen</div>
                            <div style="font-size: 0.9em; color: #2C3E50;">No activity for 5 days â€¢ Score: 45</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- CHAT PAGE -->
            <div class="page" id="chat">
                <!-- Trainee View: Simple Chat -->
                <div id="traineeChat" style="display: none;">
                    <div class="card">
                        <div class="card-title">ðŸ’¬ Chat with Coach</div>
                        <p style="color: #7f8c8d; font-size: 0.9em; margin-bottom: 15px;">Coach replies within 24 hours</p>
                        
                        <div class="chat-messages" id="traineeChatMessages"></div>
                        
                        <div class="chat-input-container">
                            <input type="file" id="traineeVideoUpload" accept="video/*" style="display: none;" onchange="uploadTraineeVideo(this)">
                            <button class="btn btn-secondary btn-small" onclick="document.getElementById('traineeVideoUpload').click()" style="width: 45px; height: 45px; padding: 0; font-size: 1.3em;">
                                ðŸ“¹
                            </button>
                            <input type="text" class="chat-input" id="traineeChatInput" placeholder="Type your message..." onkeypress="if(event.key==='Enter') sendTraineeMessage()">
                            <button class="send-btn" onclick="sendTraineeMessage()">âž¤</button>
                        </div>
                    </div>
                </div>
                
                <!-- Coach View: WhatsApp-style with trainee list -->
                <div id="coachChat" style="display: none;">
                    <div style="display: grid; grid-template-columns: 35% 65%; height: calc(100vh - 140px); gap: 0;">
                        <!-- Trainee List (Left Panel) -->
                        <div style="background: white; border-radius: 16px 0 0 16px; overflow: hidden; border-right: 1px solid #E8F5E9;">
                            <div style="padding: 20px; background: linear-gradient(135deg, #2ECC71 0%, #27AE60 100%); color: white;">
                                <div style="font-weight: bold; font-size: 1.2em; margin-bottom: 5px;">ðŸ’¬ Chats</div>
                                <div style="font-size: 0.85em; opacity: 0.9;">Select a trainee to message</div>
                            </div>
                            <div id="traineeListChat" style="overflow-y: auto; height: calc(100% - 80px);"></div>
                        </div>
                        
                        <!-- Chat Area (Right Panel) -->
                        <div style="background: white; border-radius: 0 16px 16px 0; display: flex; flex-direction: column;">
                            <!-- Chat Header -->
                            <div id="chatHeader" style="padding: 15px 20px; background: #E8F5E9; border-bottom: 1px solid #2ECC71; display: none;">
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <div style="width: 45px; height: 45px; border-radius: 50%; background: linear-gradient(135deg, #2ECC71 0%, #27AE60 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 1.2em;">
                                        <span id="chatHeaderInitial">J</span>
                                    </div>
                                    <div style="flex: 1;">
                                        <div style="font-weight: bold; color: #1E8449; font-size: 1.1em;" id="chatHeaderName">Select a trainee</div>
                                        <div style="font-size: 0.85em; color: #7f8c8d;" id="chatHeaderStatus">Click a trainee to start</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Messages Area -->
                            <div id="coachChatMessages" style="flex: 1; overflow-y: auto; padding: 20px; background: #F5F7F6;">
                                <div style="text-align: center; color: #7f8c8d; padding: 40px 20px;">
                                    <div style="font-size: 3em; margin-bottom: 10px;">ðŸ’¬</div>
                                    <div style="font-size: 1.1em; font-weight: 600; margin-bottom: 5px;">Select a Trainee</div>
                                    <div style="font-size: 0.9em;">Choose a trainee from the list to start messaging</div>
                                </div>
                            </div>
                            
                            <!-- Input Area -->
                            <div id="coachChatInput" style="padding: 15px 20px; background: white; border-top: 1px solid #E8F5E9; display: none;">
                                <div style="display: flex; gap: 10px;">
                                    <input type="file" id="coachVideoUpload" accept="video/*" style="display: none;" onchange="uploadCoachVideo(this)">
                                    <button onclick="document.getElementById('coachVideoUpload').click()" style="width: 45px; height: 45px; background: #E8F5E9; border: none; border-radius: 50%; font-size: 1.3em; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                                        ðŸ“¹
                                    </button>
                                    <input type="text" id="coachMessageInput" placeholder="Type a message..." 
                                           style="flex: 1; padding: 12px 15px; border: 2px solid #E8F5E9; border-radius: 25px; outline: none; font-size: 0.95em;"
                                           onkeypress="if(event.key==='Enter') sendCoachMessage()"
                                           onfocus="this.style.borderColor='#2ECC71'" 
                                           onblur="this.style.borderColor='#E8F5E9'">
                                    <button onclick="sendCoachMessage()" style="width: 45px; height: 45px; background: linear-gradient(135deg, #2ECC71 0%, #27AE60 100%); border: none; border-radius: 50%; color: white; font-size: 1.3em; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: transform 0.2s ease;">
                                        âž¤
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Bottom Navigation -->
        
        <!-- Animated Dumbbell Character -->
        <div class="dumbbell-buddy" id="dumbbellBuddy" onclick="goToDashboard()" title="Go to Dashboard" style="display: none;">
            <div class="dumbbell-body">
                <div class="dumbbell-left-weight"></div>
                <div class="dumbbell-bar"></div>
                <div class="dumbbell-right-weight"></div>
                <div class="dumbbell-face">
                    <div class="dumbbell-eyes">
                        <div class="dumbbell-eye"></div>
                        <div class="dumbbell-eye"></div>
                    </div>
                    <div class="dumbbell-mouth"></div>
                </div>
            </div>
        </div>
        
        <!-- Code Input Modal -->
        <div class="modal" id="codeModal">
            <div class="modal-content">
                <div class="modal-title">ðŸ”’ Coach Access Code</div>
                <p style="color: #7f8c8d; margin-bottom: 20px; text-align: center;">Enter the 4-digit code to access Coach mode</p>
                <div class="code-input">
                    <input type="text" maxlength="1" class="code-digit" id="code1" oninput="moveToNext(this, 'code2')" onkeydown="moveToPrev(event, this, null)">
                    <input type="text" maxlength="1" class="code-digit" id="code2" oninput="moveToNext(this, 'code3')" onkeydown="moveToPrev(event, this, 'code1')">
                    <input type="text" maxlength="1" class="code-digit" id="code3" oninput="moveToNext(this, 'code4')" onkeydown="moveToPrev(event, this, 'code2')">
                    <input type="text" maxlength="1" class="code-digit" id="code4" oninput="checkCode()" onkeydown="moveToPrev(event, this, 'code3')">
                </div>
                <div class="error-message" id="errorMessage" style="display: none;">âŒ Incorrect code</div>
                <div class="modal-buttons">
                    <button class="btn btn-secondary" onclick="closeModal('codeModal')">Cancel</button>
                    <button class="btn btn-primary" onclick="verifyCode()">Verify</button>
                </div>
            </div>
        </div>
        
        <!-- Add Day Modal -->
        <div class="modal" id="addDayModal">
            <div class="modal-content">
                <div class="modal-title">âž• Add Training Day</div>
                <div class="input-group">
                    <label class="input-label">Day Letter</label>
                    <input type="text" maxlength="1" class="input-field" id="newDayLetter" placeholder="D" style="text-transform: uppercase;">
                </div>
                <div class="input-group">
                    <label class="input-label">Day Title</label>
                    <input type="text" class="input-field" id="newDayTitle" placeholder="e.g. Upper Body Push">
                </div>
                <div class="modal-buttons">
                    <button class="btn btn-secondary" onclick="closeModal('addDayModal')">Cancel</button>
                    <button class="btn btn-primary" onclick="addNewDay()">Add Day</button>
                </div>
            </div>
        </div>
        
        <!-- Add Exercise Modal -->
        <div class="modal" id="addExerciseModal">
            <div class="modal-content">
                <div class="modal-title">âž• Add Exercise</div>
                <div class="input-group">
                    <label class="input-label">Exercise Name</label>
                    <input type="text" class="input-field" id="newExerciseName" placeholder="e.g. Bench Press">
                </div>
                <div class="input-group">
                    <label class="input-label">Sets</label>
                    <input type="number" class="input-field" id="newExerciseSets" placeholder="4" min="1">
                </div>
                <div class="input-group">
                    <label class="input-label">Reps</label>
                    <input type="text" class="input-field" id="newExerciseReps" placeholder="8-10">
                </div>
                <div class="modal-buttons">
                    <button class="btn btn-secondary" onclick="closeModal('addExerciseModal')">Cancel</button>
                    <button class="btn btn-primary" onclick="addNewExercise()">Add Exercise</button>
                </div>
            </div>
        </div>
        
        <!-- Add Time Slot Modal -->
        <div class="modal" id="addSlotModal">
            <div class="modal-content">
                <div class="modal-title">âž• Add Time Slot</div>
                <div class="input-group">
                    <label class="input-label">Day of Week</label>
                    <select class="input-field" id="slotDay">
                        <option value="Sunday">Sunday</option>
                        <option value="Monday">Monday</option>
                        <option value="Tuesday">Tuesday</option>
                        <option value="Wednesday">Wednesday</option>
                        <option value="Thursday">Thursday</option>
                        <option value="Friday">Friday</option>
                        <option value="Saturday">Saturday</option>
                    </select>
                </div>
                <div class="input-group">
                    <label class="input-label">Time</label>
                    <input type="time" class="input-field" id="slotTime">
                </div>
                <div class="input-group">
                    <label class="input-label">Duration (minutes)</label>
                    <select class="input-field" id="slotDuration">
                        <option value="30">30 minutes</option>
                        <option value="45">45 minutes</option>
                        <option value="60" selected>60 minutes</option>
                        <option value="90">90 minutes</option>
                    </select>
                </div>
                <div class="modal-buttons">
                    <button class="btn btn-secondary" onclick="closeModal('addSlotModal')">Cancel</button>
                    <button class="btn btn-primary" onclick="addTimeSlot()">Add Slot</button>
                </div>
            </div>
        </div>
        
        <!-- Add SMS Schedule Modal -->
        <div class="modal" id="addSMSModal">
            <div class="modal-content">
                <div class="modal-title">ðŸ“± Create SMS Schedule</div>
                <div class="input-group">
                    <label class="input-label">Message</label>
                    <textarea class="input-field" id="smsMessage" rows="4" placeholder="Stay strong! Today is another step closer to your goals! ðŸ’ª"></textarea>
                </div>
                <div class="input-group">
                    <label class="input-label">Send on Days</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <label style="display: flex; align-items: center; gap: 8px; padding: 10px; background: #f5f7f6; border-radius: 8px; cursor: pointer;">
                            <input type="checkbox" class="sms-day" value="Sunday"> Sunday
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; padding: 10px; background: #f5f7f6; border-radius: 8px; cursor: pointer;">
                            <input type="checkbox" class="sms-day" value="Monday"> Monday
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; padding: 10px; background: #f5f7f6; border-radius: 8px; cursor: pointer;">
                            <input type="checkbox" class="sms-day" value="Tuesday"> Tuesday
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; padding: 10px; background: #f5f7f6; border-radius: 8px; cursor: pointer;">
                            <input type="checkbox" class="sms-day" value="Wednesday"> Wednesday
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; padding: 10px; background: #f5f7f6; border-radius: 8px; cursor: pointer;">
                            <input type="checkbox" class="sms-day" value="Thursday"> Thursday
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; padding: 10px; background: #f5f7f6; border-radius: 8px; cursor: pointer;">
                            <input type="checkbox" class="sms-day" value="Friday"> Friday
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; padding: 10px; background: #f5f7f6; border-radius: 8px; cursor: pointer;">
                            <input type="checkbox" class="sms-day" value="Saturday"> Saturday
                        </label>
                    </div>
                </div>
                <div class="input-group">
                    <label class="input-label">Send Time</label>
                    <input type="time" class="input-field" id="smsTime" value="08:00">
                </div>
                <div class="modal-buttons">
                    <button class="btn btn-secondary" onclick="closeModal('addSMSModal')">Cancel</button>
                    <button class="btn btn-primary" onclick="addSMSSchedule()">Create Schedule</button>
                </div>
            </div>
        </div>
        
        <!-- Add Trainee Modal -->
        <div class="modal" id="addTraineeModal">
            <div class="modal-content">
                <div class="modal-title">âž• Add New Trainee</div>
                <div class="input-group">
                    <label class="input-label">Full Name</label>
                    <input type="text" class="input-field" id="newTraineeName" placeholder="e.g. John Doe">
                </div>
                <div class="input-group">
                    <label class="input-label">Email</label>
                    <input type="email" class="input-field" id="newTraineeEmail" placeholder="john@example.com">
                </div>
                <div class="input-group">
                    <label class="input-label">Phone</label>
                    <input type="tel" class="input-field" id="newTraineePhone" placeholder="+1 (555) 123-4567">
                </div>
                <div class="input-group">
                    <label class="input-label">Starting Program</label>
                    <select class="input-field" id="newTraineeProgram">
                        <option value="beginner">Beginner (3 days/week)</option>
                        <option value="intermediate">Intermediate (4 days/week)</option>
                        <option value="advanced">Advanced (5 days/week)</option>
                        <option value="custom">Custom Program</option>
                    </select>
                </div>
                <div class="modal-buttons">
                    <button class="btn btn-secondary" onclick="closeModal('addTraineeModal')">Cancel</button>
                    <button class="btn btn-primary" onclick="addNewTrainee()">Add Trainee</button>
                </div>
            </div>
        </div>
    </div>
    
    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
        // Button wiring â€” ensures login buttons fire the right functions
        document.addEventListener('DOMContentLoaded', () => {
            const traineeBtn = document.querySelector('#traineeLoginPage .btn-primary');
            if (traineeBtn) {
                traineeBtn.addEventListener('click', (e) => { e.preventDefault(); loginAsTrainee(); });
            }
            const coachBtn = document.querySelector('#coachLoginPage .btn-primary');
            if (coachBtn) {
                coachBtn.addEventListener('click', (e) => { e.preventDefault(); loginAsCoach(); });
            }
        });
        // ========== SOUND EFFECTS SYSTEM ==========
        
        // Create audio context for sound effects
        let audioContext = null;
        let soundEnabled = true;
        
        // Initialize audio context (needs user interaction first)
        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }
        
        // Play friendly bubble pop sound
        function playClickSound() {
            if (!soundEnabled || !audioContext) return;
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            // Friendly bubble pop - higher pitch, softer
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(1400, audioContext.currentTime);
            oscillator.frequency.exponentialRampToValueAtTime(600, audioContext.currentTime + 0.1);
            
            gainNode.gain.setValueAtTime(0.15, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.1);
        }
        
        // Play cheerful success sound (happy bubbles)
        function playSuccessSound() {
            if (!soundEnabled || !audioContext) return;
            
            // Happy ascending notes
            const times = [0, 0.08, 0.16];
            const freqs = [600, 800, 1000];
            
            times.forEach((time, i) => {
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                
                osc.connect(gain);
                gain.connect(audioContext.destination);
                
                osc.type = 'sine';
                osc.frequency.setValueAtTime(freqs[i], audioContext.currentTime + time);
                
                gain.gain.setValueAtTime(0.12, audioContext.currentTime + time);
                gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + time + 0.15);
                
                osc.start(audioContext.currentTime + time);
                osc.stop(audioContext.currentTime + time + 0.15);
            });
        }
        
        // Play celebration sound (achievement unlocked!)
        function playCompleteSound() {
            if (!soundEnabled || !audioContext) return;
            
            // Celebratory chord progression
            const chord1 = [523, 659, 784]; // C major
            const chord2 = [587, 740, 880]; // D major
            
            // First chord
            chord1.forEach(freq => {
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                osc.connect(gain);
                gain.connect(audioContext.destination);
                osc.type = 'sine';
                osc.frequency.setValueAtTime(freq, audioContext.currentTime);
                gain.gain.setValueAtTime(0.08, audioContext.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                osc.start(audioContext.currentTime);
                osc.stop(audioContext.currentTime + 0.2);
            });
            
            // Second chord
            chord2.forEach(freq => {
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                osc.connect(gain);
                gain.connect(audioContext.destination);
                osc.type = 'sine';
                osc.frequency.setValueAtTime(freq, audioContext.currentTime + 0.15);
                gain.gain.setValueAtTime(0.08, audioContext.currentTime + 0.15);
                gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.35);
                osc.start(audioContext.currentTime + 0.15);
                osc.stop(audioContext.currentTime + 0.35);
            });
        }
        
        // Play gentle error sound (friendly "oops")
        function playErrorSound() {
            if (!soundEnabled || !audioContext) return;
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            // Gentle descending sound
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(500, audioContext.currentTime);
            oscillator.frequency.exponentialRampToValueAtTime(350, audioContext.currentTime + 0.15);
            
            gainNode.gain.setValueAtTime(0.12, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.15);
        }
        
        // Play friendly SMS notification (cheerful tri-tone)
        function playSMSSound() {
            if (!soundEnabled || !audioContext) return;
            
            // Cheerful notification melody
            const melody = [
                { freq: 880, time: 0 },
                { freq: 1047, time: 0.12 },
                { freq: 784, time: 0.24 }
            ];
            
            melody.forEach(note => {
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                osc.connect(gain);
                gain.connect(audioContext.destination);
                osc.type = 'sine';
                osc.frequency.setValueAtTime(note.freq, audioContext.currentTime + note.time);
                gain.gain.setValueAtTime(0.2, audioContext.currentTime + note.time);
                gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + note.time + 0.18);
                osc.start(audioContext.currentTime + note.time);
                osc.stop(audioContext.currentTime + note.time + 0.18);
            });
        }
        
        
        // Underwater bubbly fish sound - for buddy talking
        function playBuddySound() {
            if (!soundEnabled || !audioContext) return;
            
            // Main bubble wobble (like underwater)
            const bubbles = [
                { freq: 300, time: 0, wobble: 320 },
                { freq: 450, time: 0.08, wobble: 480 },
                { freq: 380, time: 0.16, wobble: 400 }
            ];
            
            bubbles.forEach(bubble => {
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                
                // Create LFO for wobble effect (underwater feeling)
                const lfo = audioContext.createOscillator();
                const lfoGain = audioContext.createGain();
                
                lfo.frequency.setValueAtTime(8, audioContext.currentTime); // Wobble speed
                lfoGain.gain.setValueAtTime(20, audioContext.currentTime); // Wobble depth
                
                lfo.connect(lfoGain);
                lfoGain.connect(osc.frequency);
                
                osc.connect(gain);
                gain.connect(audioContext.destination);
                
                osc.type = 'sine';
                osc.frequency.setValueAtTime(bubble.freq, audioContext.currentTime + bubble.time);
                osc.frequency.exponentialRampToValueAtTime(bubble.wobble, audioContext.currentTime + bubble.time + 0.12);
                
                gain.gain.setValueAtTime(0.12, audioContext.currentTime + bubble.time);
                gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + bubble.time + 0.12);
                
                lfo.start(audioContext.currentTime + bubble.time);
                lfo.stop(audioContext.currentTime + bubble.time + 0.12);
                
                osc.start(audioContext.currentTime + bubble.time);
                osc.stop(audioContext.currentTime + bubble.time + 0.12);
            });
            
            // Add tiny bubble pops at the end (fish blowing bubbles)
            setTimeout(() => {
                const pop1 = audioContext.createOscillator();
                const popGain1 = audioContext.createGain();
                pop1.connect(popGain1);
                popGain1.connect(audioContext.destination);
                pop1.type = 'sine';
                pop1.frequency.setValueAtTime(1400, audioContext.currentTime);
                pop1.frequency.exponentialRampToValueAtTime(700, audioContext.currentTime + 0.04);
                popGain1.gain.setValueAtTime(0.08, audioContext.currentTime);
                popGain1.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.04);
                pop1.start(audioContext.currentTime);
                pop1.stop(audioContext.currentTime + 0.04);
                
                // Second tiny bubble
                setTimeout(() => {
                    const pop2 = audioContext.createOscillator();
                    const popGain2 = audioContext.createGain();
                    pop2.connect(popGain2);
                    popGain2.connect(audioContext.destination);
                    pop2.type = 'sine';
                    pop2.frequency.setValueAtTime(1600, audioContext.currentTime);
                    pop2.frequency.exponentialRampToValueAtTime(800, audioContext.currentTime + 0.03);
                    popGain2.gain.setValueAtTime(0.06, audioContext.currentTime);
                    popGain2.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.03);
                    pop2.start(audioContext.currentTime);
                    pop2.stop(audioContext.currentTime + 0.03);
                }, 50);
            }, 200);
        }
        
        // ========== END SOUND EFFECTS SYSTEM ==========
        
        // App State
        let appState = {
            userRole: 'trainee',
            score: 85,
            workoutsCompleted: 3,
            totalWorkouts: 5,
            nutritionScore: 8,
            sleepAverage: 7.5,
            currentMission: "Eat 180g protein every day",
            missionRating: 7,
            currentDay: null,
            currentUserBookedSlot: null, // Which slot the current user booked
            currentTraineeId: 1, // Current trainee being managed by coach
            buddySpeechTimeout: null,
            trainees: [
                {
                    id: 1,
                    name: 'John Doe',
                    email: 'john@example.com',
                    phone: '+1 (555) 123-4567',
                    score: 85,
                    workoutsCompleted: 3,
                    totalWorkouts: 5,
                    nutritionScore: 8,
                    sleepAverage: 7.5,
                    lastActive: '2 hours ago',
                    joinDate: '2024-01-15',
                    status: 'active',
                    program: 'intermediate'
                },
                {
                    id: 2,
                    name: 'Sarah Johnson',
                    email: 'sarah@example.com',
                    phone: '+1 (555) 234-5678',
                    score: 68,
                    workoutsCompleted: 2,
                    totalWorkouts: 5,
                    nutritionScore: 6,
                    sleepAverage: 6.5,
                    lastActive: '1 day ago',
                    joinDate: '2024-01-20',
                    status: 'attention',
                    program: 'beginner'
                },
                {
                    id: 3,
                    name: 'Mike Chen',
                    email: 'mike@example.com',
                    phone: '+1 (555) 345-6789',
                    score: 45,
                    workoutsCompleted: 1,
                    totalWorkouts: 5,
                    nutritionScore: 4,
                    sleepAverage: 5.5,
                    lastActive: '5 days ago',
                    joinDate: '2024-02-01',
                    status: 'inactive',
                    program: 'beginner'
                },
                {
                    id: 4,
                    name: 'Emma Williams',
                    email: 'emma@example.com',
                    phone: '+1 (555) 456-7890',
                    score: 92,
                    workoutsCompleted: 5,
                    totalWorkouts: 5,
                    nutritionScore: 9,
                    sleepAverage: 8.0,
                    lastActive: '30 mins ago',
                    joinDate: '2024-01-10',
                    status: 'active',
                    program: 'advanced'
                },
                {
                    id: 5,
                    name: 'David Brown',
                    email: 'david@example.com',
                    phone: '+1 (555) 567-8901',
                    score: 78,
                    workoutsCompleted: 4,
                    totalWorkouts: 5,
                    nutritionScore: 7,
                    sleepAverage: 7.0,
                    lastActive: '3 hours ago',
                    joinDate: '2024-01-25',
                    status: 'active',
                    program: 'intermediate'
                }
            ],
            nextTraineeId: 6,
            smsSchedules: [
                { id: 1, message: "Good morning! Time to crush today's workout! ðŸ’ª", days: ['Monday', 'Wednesday', 'Friday'], time: '08:00' },
                { id: 2, message: "Remember your nutrition goals today! ðŸ¥—", days: ['Tuesday', 'Thursday', 'Saturday'], time: '12:00' }
            ],
            nextSMSId: 3,
            callSlots: [
                { id: 1, day: 'Sunday', time: '10:00', duration: 60, bookedBy: null },
                { id: 2, day: 'Sunday', time: '14:00', duration: 60, bookedBy: null },
                { id: 3, day: 'Monday', time: '09:00', duration: 60, bookedBy: 'John Doe' },
                { id: 4, day: 'Tuesday', time: '16:00', duration: 60, bookedBy: null },
                { id: 5, day: 'Wednesday', time: '11:00', duration: 60, bookedBy: null }
            ],
            nextSlotId: 6,
            trainingDays: [
                {
                    letter: 'A',
                    title: 'Upper Body Push',
                    completed: true,
                    trainerNote: 'Focus on chest activation today. Really squeeze at the top of each press movement! ðŸ’ª',
                    exercises: [
                        { name: 'Bench Press', sets: 4, reps: '8', rir: '', weight: '', coachNote: 'Focus on controlled descent', traineeNote: '' },
                        { name: 'Overhead Press', sets: 3, reps: '10', rir: '', weight: '', coachNote: '', traineeNote: '' },
                        { name: 'Dips', sets: 3, reps: '12', rir: '', weight: '', coachNote: '', traineeNote: '' }
                    ]
                },
                {
                    letter: 'B',
                    title: 'Lower Body',
                    completed: false,
                    trainerNote: 'Leg day! Remember: depth over weight. Full range of motion is key. You got this! ðŸ”¥',
                    exercises: [
                        { name: 'Back Squat', sets: 4, reps: '6', rir: '', weight: '', coachNote: 'Go below parallel', traineeNote: '' },
                        { name: 'Romanian Deadlift', sets: 3, reps: '10', rir: '', weight: '', coachNote: '', traineeNote: '' },
                        { name: 'Bulgarian Split Squat', sets: 3, reps: '12', rir: '', weight: '', coachNote: '', traineeNote: '' }
                    ]
                },
                {
                    letter: 'C',
                    title: 'Upper Body Pull',
                    completed: false,
                    trainerNote: 'Pull day - think about pulling with your elbows, not your hands. Back thickness coming! ðŸ’¯',
                    exercises: [
                        { name: 'Pull-ups', sets: 4, reps: '8', rir: '', weight: '', coachNote: 'Use assistance if needed', traineeNote: '' },
                        { name: 'Barbell Rows', sets: 4, reps: '10', rir: '', weight: '', coachNote: '', traineeNote: '' },
                        { name: 'Face Pulls', sets: 3, reps: '15', rir: '', weight: '', coachNote: '', traineeNote: '' }
                    ]
                }
            ],
            pageHistory: [],
            selectedChatTraineeId: null, // Currently selected trainee in coach chat
            chatMessages: {
                // traineeId: [{from: 'coach'/'trainee', message: 'text', time: 'timestamp'}]
                1: [
                    { from: 'coach', message: 'Great job on completing Day A! Keep pushing! ðŸ’ª', time: '10:30 AM' },
                    { from: 'trainee', message: 'Thanks! Feeling strong today. Ready for Day B tomorrow.', time: '11:15 AM' },
                    { from: 'coach', message: 'Perfect! Remember to focus on form during squats. Film a set if you want feedback.', time: '11:20 AM' }
                ],
                2: [
                    { from: 'coach', message: 'Hey Sarah! How are you feeling today?', time: 'Yesterday' },
                    { from: 'trainee', message: 'A bit tired, but ready to work!', time: 'Yesterday' }
                ],
                3: [
                    { from: 'coach', message: 'Mike, haven\'t seen you in the gym. Everything okay?', time: '3 days ago' }
                ],
                4: [
                    { from: 'trainee', message: 'Just finished my workout! New PR on bench! ðŸŽ‰', time: '1 hour ago' },
                    { from: 'coach', message: 'Amazing work Emma! What was the weight?', time: '45 mins ago' },
                    { from: 'trainee', message: '135 lbs for 5 reps!', time: '40 mins ago' }
                ],
                5: []
            }
        };
        
        
        // ========== BUDDY SPEECH SYSTEM ==========
        
        // Buddy messages for each page
        const buddyMessages = {
            'signup': { emoji: 'ðŸ‘‹', text: 'Welcome! Ready to start your fitness journey?' },
            'traineeLogin': { emoji: 'ðŸ’ª', text: 'Login and let\'s get stronger together!' },
            'coachLogin': { emoji: 'ðŸŽ“', text: 'Welcome back, Coach! Your trainees need you!' },
            'traineeSignup': { emoji: 'ðŸ‘¤', text: 'Sign up and start your transformation!' },
            'coachSignup': { emoji: 'ðŸŽ“', text: 'Join as a coach and inspire others!' },
            'dashboard': { emoji: 'ðŸ“Š', text: 'Here\'s your performance overview. Keep it up!' },
            'coachDashboard': { emoji: 'ðŸŽ“', text: 'Your coaching overview! Tap me to return here anytime!' },
            'program': { emoji: 'ðŸ‹ï¸', text: 'Your training program! Tap a day to see exercises.' },
            'dayDetail': { emoji: 'ðŸ’ª', text: 'Remember: form over weight! You got this!' },
            'missions': { emoji: 'ðŸŽ¯', text: 'Track your nutrition and sleep here!' },
            'calls': { emoji: 'ðŸ“ž', text: 'Schedule a call with your coach anytime!' },
            'chat': { emoji: 'ðŸ’¬', text: 'Message your coach - they respond within 24hrs!' },
            'notifications': { emoji: 'ðŸ“±', text: 'Set up automated motivation for trainees!' },
            'trainees': { emoji: 'ðŸ‘¥', text: 'All your trainees in one place. Tap to switch!' }
        };
        
        // Show buddy speech bubble
        function showBuddySpeech(pageId) {
            // Clear any existing speech
            const existingSpeech = document.getElementById('buddySpeech');
            if (existingSpeech) {
                existingSpeech.remove();
            }
            
            // Clear timeout
            if (appState.buddySpeechTimeout) {
                clearTimeout(appState.buddySpeechTimeout);
            }
            
            // Get message for this page
            const message = buddyMessages[pageId];
            if (!message) return;
            
            // Play underwater bubble sound
            initAudio();
            playBuddySound();
            
            // Create speech bubble
            const speech = document.createElement('div');
            speech.id = 'buddySpeech';
            speech.className = 'buddy-speech';
            speech.innerHTML = `
                <div class="buddy-speech-text">
                    <span class="buddy-speech-emoji">${message.emoji}</span>
                    ${message.text}
                </div>
            `;
            
            document.body.appendChild(speech);
            
            // Auto-hide after 5 seconds
            appState.buddySpeechTimeout = setTimeout(() => {
                speech.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                speech.style.opacity = '0';
                speech.style.transform = 'translateY(10px)';
                setTimeout(() => speech.remove(), 300);
            }, 5000);
        }
        
        // Hide buddy speech
        function hideBuddySpeech() {
            const speech = document.getElementById('buddySpeech');
            if (speech) {
                speech.style.transition = 'opacity 0.3s ease';
                speech.style.opacity = '0';
                setTimeout(() => speech.remove(), 300);
            }
        }
        
        // ========== END BUDDY SPEECH SYSTEM ==========
        
        // Initialize app
        // ========== USER DATABASE SYSTEM ==========
        
        function loadDB() {
            try {
                const raw = localStorage.getItem('users_v1');
                if (!raw) return { trainees: [], coaches: [] };
                const db = JSON.parse(raw);
                if (!db.trainees || !db.coaches) return { trainees: [], coaches: [] };
                return db;
            } catch (e) {
                return { trainees: [], coaches: [] };
            }
        }
        
        function saveDB(db) {
            localStorage.setItem('users_v1', JSON.stringify(db));
        }
        
        function normalizeEmail(email) {
            return email.trim().toLowerCase();
        }
        
        function findUserByEmail(db, emailNorm) {
            const trainee = db.trainees.find(u => u.emailNormalized === emailNorm);
            if (trainee) return { role: 'trainee', user: trainee };
            const coach = db.coaches.find(u => u.emailNormalized === emailNorm);
            if (coach) return { role: 'coach', user: coach };
            return null;
        }
        
        function createSession(role, user) {
            const session = { userId: user.id, role, email: user.emailNormalized, name: user.name, loginAt: Date.now() };
            localStorage.setItem('session_v1', JSON.stringify(session));
            return session;
        }
        
        function clearSession() {
            localStorage.removeItem('session_v1');
        }
        
        function getSession() {
            try {
                const raw = localStorage.getItem('session_v1');
                if (!raw) return null;
                return JSON.parse(raw);
            } catch (e) {
                return null;
            }
        }
        
        function genId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        }
        

        function showInlineError(elId, msg) {
            let el = document.getElementById(elId);
            if (!el) { alert(msg); return; }
            el.textContent = msg;
            el.style.display = 'block';
        }
        
        function clearInlineError(elId) {
            let el = document.getElementById(elId);
            if (el) { el.textContent = ''; el.style.display = 'none'; }
        }

        
        // ========== END USER DATABASE SYSTEM ==========
        
        function initApp() {
            renderTrainingDays();
            calculateScore();
        }
        
        // Select Signup Type
        function selectSignupType(type) {
            initAudio();
            playClickSound();
            if (type === 'trainee') {
                showPage('traineeSignup');
            } else if (type === 'coach') {
                showPage('coachSignup');
            }
        }
        
        // completeTraineeSignup() â€” called by the "Start My Journey" button
        async function completeTraineeSignup() {
            // Task 6: Firebase readiness guard
            if (!window.__FIREBASE_READY__ || !window.fb?.auth || !window.fb?.db) {
                mini('Firebase not ready (config/domain/init)');
                showInlineError('traineeSignupError', 'âš ï¸ Firebase not ready. Please refresh and try again.');
                throw new Error('Firebase not ready');
            }
            clearInlineError('traineeSignupError');

            const name     = (document.getElementById('traineeSignupName')?.value     || '').trim();
            const email    = (document.getElementById('traineeSignupEmail')?.value    || '').trim();
            const phone    = (document.getElementById('traineeSignupPhone')?.value    || '').trim();
            const password = (document.getElementById('traineeSignupPassword')?.value || '').trim();
            const goal     =  document.getElementById('traineeSignupGoal')?.value     || '';

            if (!name || !email || !phone || !password || !goal) {
                if (typeof playErrorSound === 'function') { initAudio(); playErrorSound(); }
                showInlineError('traineeSignupError', 'âš ï¸ Please fill in all fields.');
                return;
            }
            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                if (typeof playErrorSound === 'function') { initAudio(); playErrorSound(); }
                showInlineError('traineeSignupError', 'âš ï¸ Please enter a valid email address.');
                return;
            }
            if (password.length < 6) {
                if (typeof playErrorSound === 'function') { initAudio(); playErrorSound(); }
                showInlineError('traineeSignupError', 'âš ï¸ Password must be at least 6 characters.');
                return;
            }

            const { auth, db, createUserWithEmailAndPassword, setDoc, doc, serverTimestamp } = window.FirebaseFns;
            const emailNorm = normalizeEmail(email);
            try {
                const cred = await createUserWithEmailAndPassword(auth, emailNorm, password);
                await setDoc(doc(db, 'profiles', cred.user.uid), {
                    role: 'trainee', name, phone, goal,
                    emailNormalized: emailNorm,
                    createdAt: serverTimestamp()
                });
                if (typeof playCompleteSound === 'function') { initAudio(); playCompleteSound(); }
                appState.userRole = 'trainee';
                const greet = document.getElementById('userGreetingName');
                if (greet) greet.textContent = name.split(' ')[0];
                updateUI();
                showPage('traineeDashboardPage');
            } catch (err) {
                if (typeof playErrorSound === 'function') { initAudio(); playErrorSound(); }
                if (err.code === 'auth/email-already-in-use') {
                    showInlineError('traineeSignupError', 'âš ï¸ This email is already registered. Please log in.');
                } else if (err.code === 'auth/weak-password') {
                    showInlineError('traineeSignupError', 'âš ï¸ Password must be at least 6 characters.');
                } else {
                    showInlineError('traineeSignupError', 'âš ï¸ Signup failed: ' + (err.message || err.code));
                }
            }
        }
        window.completeTraineeSignup = completeTraineeSignup; // Task 4: explicit global export
        
        // Show Trainee Login
        function showTraineeLogin() {
            initAudio();
            playClickSound();
            showPage('traineeLoginPage');
        }
        
        // Show Coach Login
        function showCoachLogin() {
            initAudio();
            playClickSound();
            showPage('coachLoginPage');
        }
        


        // Show Welcome Animation
        function showWelcomeAnimation(name) {
            const welcome = document.createElement('div');
            welcome.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:linear-gradient(135deg,#2ECC71,#27AE60);color:white;padding:30px;border-radius:16px;box-shadow:0 8px 30px rgba(46,204,113,0.5);z-index:1000;text-align:center;max-width:90%';
            welcome.innerHTML = `<div style="font-size:3em;margin-bottom:15px">ðŸŽ‰</div><div style="font-size:1.5em;font-weight:bold;margin-bottom:10px">Welcome, ${name.split(' ')[0]}!</div><div style="font-size:1.1em">Let's start your fitness journey!</div>`;
            document.body.appendChild(welcome);
            setTimeout(() => {
                welcome.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
                welcome.style.opacity = '0';
                welcome.style.transform = 'translate(-50%,-50%) scale(0.9)';
                setTimeout(() => { welcome.remove(); showPage('traineeDashboardPage'); }, 500);
            }, 2000);
        }
        

        
        // Go to Dashboard (from buddy click)
        function goToDashboard() {
            initAudio();
            playSuccessSound();
            
            if (appState.userRole === 'coach') {
                showPage('coachDashboardPage');
                renderCoachDashboard();
            } else {
                showPage('traineeDashboardPage');
            }
        }
        
        // Render Coach Dashboard
        function renderCoachDashboard() {
            const totalTrainees = appState.trainees.length;
            const activeTrainees = appState.trainees.filter(t => t.status === 'active').length;
            const avgScore = totalTrainees ? Math.round(appState.trainees.reduce((sum, t) => sum + t.score, 0) / totalTrainees) : 0;
            const unreadMessages = Object.values(appState.chatMessages).reduce((sum, msgs) =>
                sum + msgs.filter(m => m.from === 'trainee' && !m.read).length, 0);

            // Safely update stat elements (they exist in the one real coachDashboard)
            const safeSet = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
            safeSet('coachTotalTrainees', totalTrainees);
            safeSet('coachActiveTrainees', activeTrainees);
            safeSet('coachAvgScore', avgScore);
            safeSet('coachUnreadMessages', unreadMessages);

            // coachAttentionList is in the real coachDashboard (topPerformers/needsAttentionList were in the old deleted duplicate)
            const attentionContainer = document.getElementById('coachAttentionList');
            if (attentionContainer) {
                const needsAttention = appState.trainees.filter(t => t.status === 'attention' || t.status === 'inactive');
                if (needsAttention.length > 0) {
                    attentionContainer.innerHTML = needsAttention.map(trainee => `
                        <div style="background:${trainee.status==='inactive'?'#F8D7DA':'#FFF3CD'};padding:15px;border-radius:8px;margin-bottom:10px;border-left:4px solid ${trainee.status==='inactive'?'#E74C3C':'#F39C12'};cursor:pointer" onclick="switchTrainee(${trainee.id}); showPage('trainees')">
                            <div style="font-weight:600;color:${trainee.status==='inactive'?'#721C24':'#856404'};margin-bottom:5px">${trainee.name}</div>
                            <div style="font-size:0.9em;color:#2C3E50">Score: ${trainee.score} â€¢ ${trainee.workoutsCompleted}/${trainee.totalWorkouts} workouts</div>
                        </div>`).join('');
                }
            }
        }
        
        // Upload Trainee Video
        function uploadTraineeVideo(input) {
            const file = input.files[0];
            if (!file) return;
            
            initAudio();
            playSuccessSound();
            
            // Add video message to chat
            if (!appState.chatMessages[1]) appState.chatMessages[1] = [];
            appState.chatMessages[1].push({
                from: 'trainee',
                message: `ðŸ“¹ Video: ${file.name}`,
                time: new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }),
                isVideo: true,
                videoName: file.name
            });
            
            renderTraineeMessages();
            input.value = ''; // Reset input
            
            // Show notification
            alert('âœ… Video uploaded! Your coach will review it soon.');
        }
        
        // Upload Coach Video
        function uploadCoachVideo(input) {
            if (!appState.selectedChatTraineeId) return;
            
            const file = input.files[0];
            if (!file) return;
            
            initAudio();
            playSuccessSound();
            
            // Add video message
            if (!appState.chatMessages[appState.selectedChatTraineeId]) {
                appState.chatMessages[appState.selectedChatTraineeId] = [];
            }
            
            appState.chatMessages[appState.selectedChatTraineeId].push({
                from: 'coach',
                message: `ðŸ“¹ Video: ${file.name}`,
                time: new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }),
                read: true,
                isVideo: true,
                videoName: file.name
            });
            
            renderCoachMessages(appState.selectedChatTraineeId);
            renderTraineeListForChat();
            input.value = ''; // Reset input
        }
        
        // Toggle Menu
        function toggleMenu() {
            const menu = document.querySelector('.side-menu');
            const overlay = document.querySelector('.menu-overlay');
            menu.classList.toggle('active');
            overlay.classList.toggle('active');
        }
        
        // Show Page
        function showPage(pageId) {
            
            // Save current page to history
            const currentPage = document.querySelector('.page.active');
            if (currentPage && currentPage.id) {
                appState.pageHistory.push(currentPage.id);
            }
            
            // Hide ALL pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // Show target page â€” with null guard
            const target = document.getElementById(pageId);
            if (!target) {
                console.error('showPage ERROR: no element found with id:', pageId);
                return;
            }
            target.classList.add('active');
            
            // Update menu items
            document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
            
            // Update title
            const titles = {
                'signup': 'âš¡ Performance Coach',
                'traineeSignup': 'ðŸ‘¤ Trainee Sign Up',
                'coachSignup': 'ðŸŽ“ Coach Sign Up',
                'traineeLoginPage': 'ðŸ‘¤ Trainee Login',
                'coachLoginPage': 'ðŸŽ“ Coach Login',
                'traineeDashboardPage': 'âš¡ Performance Coach',
                'coachDashboardPage': 'ðŸŽ“ Coach Dashboard',
                'program': 'ðŸ‹ï¸ Training Program',
                'dayDetail': 'ðŸ’ª Workout Details',
                'missions': 'ðŸŽ¯ Missions',
                'calls': 'ðŸ“ž Schedule Calls',
                'notifications': 'ðŸ“± SMS Notifications',
                'trainees': 'ðŸ‘¥ Manage Trainees',
                'chat': 'ðŸ’¬ Chat'
            };
            const titleEl = document.getElementById('topTitle');
            if (titleEl) titleEl.textContent = titles[pageId] || 'âš¡ Performance Coach';
            
            // Close menu
            const menu = document.querySelector('.side-menu');
            const overlay = document.querySelector('.menu-overlay');
            if (menu) menu.classList.remove('active');
            if (overlay) overlay.classList.remove('active');
            
            // Page-specific rendering
            if (pageId === 'calls') renderCallSlots();
            if (pageId === 'notifications') renderSMSSchedules();
            if (pageId === 'trainees') renderTraineesList();
            if (pageId === 'chat') renderChat();
            if (pageId === 'coachDashboardPage') { try { renderCoachDashboard(); } catch(e) { console.error('renderCoachDashboard error:', e); } }
            if (pageId === 'traineeDashboardPage') { try { refreshBWUI(); } catch(e) {} }
            
            // Show/hide top bar and exit button
            const exitBtn = document.getElementById('exitBtn');
            const topBar = document.getElementById('topBar');
            const isAuthPage = ['signup','traineeLoginPage','coachLoginPage','traineeSignup','coachSignup'].includes(pageId);
            const isDashboard = (pageId === 'traineeDashboardPage' || pageId === 'coachDashboardPage');
            
            if (isAuthPage) {
                if (topBar) topBar.style.display = 'none';
                if (exitBtn) exitBtn.style.display = 'none';
            } else {
                if (topBar) topBar.style.display = 'flex';
                if (exitBtn) {
                    exitBtn.style.display = 'flex';
                    if (isDashboard) {
                        exitBtn.onclick = logout;
                        exitBtn.title = 'Exit';
                        exitBtn.style.borderRadius = '4px 4px 0 0';
                    } else {
                        exitBtn.onclick = goBack;
                        exitBtn.title = 'Back';
                        exitBtn.style.borderRadius = '8px';
                    }
                }
            }
            
            // Show/hide buddy
            const buddy = document.getElementById('dumbbellBuddy');
            if (buddy) buddy.style.display = isAuthPage ? 'none' : 'block';
            
            // Buddy speech
            showBuddySpeech(pageId);
        }
        
        // Update Back Button
        // Go Back
        function goBack() {
            if (appState.pageHistory.length > 0) {
                const previousPage = appState.pageHistory.pop();
                showPageDirect(previousPage);
            } else {
                // If no history, go to appropriate dashboard
                if (appState.userRole === 'coach') {
                    showPage('coachDashboardPage');
                } else {
                    showPage('traineeDashboardPage');
                }
            }
        }
        
        // Show Page Direct (without adding to history)
        function showPageDirect(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId).classList.add('active');
            
            const titles = {
                'signup': 'âš¡ Performance Coach',
                'traineeSignup': 'ðŸ‘¤ Trainee Sign Up',
                'coachSignup': 'ðŸŽ“ Coach Sign Up',
                'traineeLoginPage': 'ðŸ‘¤ Trainee Login',
                'coachLoginPage': 'ðŸŽ“ Coach Login',
                'traineeDashboardPage': 'âš¡ Performance Coach',
                'coachDashboardPage': 'ðŸŽ“ Coach Dashboard',
                'program': 'ðŸ‹ï¸ Training Program',
                'dayDetail': 'ðŸ’ª Workout Details',
                'missions': 'ðŸŽ¯ Missions',
                'calls': 'ðŸ“ž Schedule Calls',
                'notifications': 'ðŸ“± SMS Notifications',
                'trainees': 'ðŸ‘¥ Manage Trainees',
                'chat': 'ðŸ’¬ Chat'
            };
            document.getElementById('topTitle').textContent = titles[pageId] || 'âš¡ Performance Coach';
            
            // Update exit/back button
            const exitBtn = document.getElementById('exitBtn');
            const isDashboard = (pageId === 'traineeDashboardPage' || pageId === 'coachDashboardPage');
            
            if (isDashboard) {
                exitBtn.onclick = logout;
                exitBtn.title = 'Exit';
                exitBtn.style.borderRadius = '4px 4px 0 0';
            } else {
                exitBtn.onclick = goBack;
                exitBtn.title = 'Back';
                exitBtn.style.borderRadius = '8px';
            }
        }
        
        // Attempt Switch Role
        function attemptSwitchRole() {
            if (appState.userRole === 'trainee') {
                openModal('codeModal');
                setTimeout(() => document.getElementById('code1').focus(), 300);
            } else {
                switchToTrainee();
                toggleMenu();
            }
        }
        
        // Code Input Functions
        function moveToNext(current, nextId) {
            if (current.value.length === 1 && nextId) {
                document.getElementById(nextId).focus();
            }
        }
        
        function moveToPrev(event, current, prevId) {
            if (event.key === 'Backspace' && current.value.length === 0 && prevId) {
                document.getElementById(prevId).focus();
            }
        }
        
        function checkCode() {
            // Auto-verify when all 4 digits entered
            setTimeout(() => {
                const code1 = document.getElementById('code1').value;
                const code2 = document.getElementById('code2').value;
                const code3 = document.getElementById('code3').value;
                const code4 = document.getElementById('code4').value;
                if (code1 && code2 && code3 && code4) {
                    verifyCode();
                }
            }, 100);
        }
        
        function verifyCode() {
            const code1 = document.getElementById('code1').value;
            const code2 = document.getElementById('code2').value;
            const code3 = document.getElementById('code3').value;
            const code4 = document.getElementById('code4').value;
            const code = code1 + code2 + code3 + code4;
            
            initAudio();
            
            if (code === '1240') {
                playSuccessSound();
                appState.userRole = 'coach';
                updateUI();
                closeModal('codeModal');
                clearCodeInputs();
                toggleMenu();
            } else {
                playErrorSound();
                document.getElementById('errorMessage').style.display = 'block';
                clearCodeInputs();
                document.getElementById('code1').focus();
                setTimeout(() => {
                    document.getElementById('errorMessage').style.display = 'none';
                }, 2000);
            }
        }
        
        function clearCodeInputs() {
            document.getElementById('code1').value = '';
            document.getElementById('code2').value = '';
            document.getElementById('code3').value = '';
            document.getElementById('code4').value = '';
        }
        
        function switchToTrainee() {
            appState.userRole = 'trainee';
            updateUI();
        }
        
        // Update UI based on role
        function updateUI() {
            const isCoach = appState.userRole === 'coach';
            
            // Helper â€” set text safely
            const setText = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
            const setDisplay = (id, val) => { const el = document.getElementById(id); if (el) el.style.display = val; };
            
            // Update menu names
            setText('menuUserName', isCoach ? 'Coach Admin' : (localStorage.getItem('userName') || 'Trainee'));
            setText('menuUserRole', isCoach ? 'Coach' : 'Trainee');
            // switchRoleText was removed â€” skip it
            
            // Show/hide coach-only controls
            setDisplay('addDayBtn', isCoach ? 'block' : 'none');
            setDisplay('addExerciseBtn', isCoach ? 'block' : 'none');
            setDisplay('editDayNameBtn', isCoach ? 'inline-block' : 'none');
            setDisplay('editMissionsCard', isCoach ? 'block' : 'none');
            setDisplay('notificationsMenuItem', isCoach ? 'flex' : 'none');
            setDisplay('traineesMenuItem', isCoach ? 'flex' : 'none');

            // topBar visibility is owned by showPage() and onAuthStateChanged.
            // Guard: if no authenticated role is set, keep topBar hidden.
            if (!appState.userRole) {
                setDisplay('topBar', 'none');
            }
            
            // Re-render if needed
            if (appState.currentDay !== null) {
                try { renderExercises(); } catch(e) {}
            }
            try { renderTrainingDays(); } catch(e) {}
        }
        
        // Render Training Days
        function renderTrainingDays() {
            const container = document.getElementById('trainingDaysList');
            container.innerHTML = '';
            
            appState.trainingDays.forEach((day, index) => {
                const dayCard = document.createElement('div');
                dayCard.className = `day-card ${day.completed ? 'completed' : ''}`;
                dayCard.onclick = () => openDayDetail(index);
                
                dayCard.innerHTML = `
                    <div class="day-header">
                        <div class="day-left">
                            <div class="day-letter">${day.letter}</div>
                            <div class="day-info">
                                <h3>${day.title}</h3>
                                <p>${day.exercises.length} exercises</p>
                            </div>
                        </div>
                        <div class="day-arrow">â†’</div>
                    </div>
                `;
                
                container.appendChild(dayCard);
            });
        }
        
        // Open Day Detail
        function openDayDetail(dayIndex) {
            initAudio();
            playClickSound();
            
            appState.currentDay = dayIndex;
            const day = appState.trainingDays[dayIndex];
            
            document.getElementById('detailDayLetter').textContent = day.letter;
            document.getElementById('detailDayTitle').textContent = day.title;
            
            // Render trainer note
            const trainerNoteSection = document.getElementById('trainerNoteSection');
            const isCoach = appState.userRole === 'coach';
            
            if (day.trainerNote || isCoach) {
                trainerNoteSection.innerHTML = `
                    <div style="background: linear-gradient(135deg, #FFF9E6 0%, #FFE6CC 100%); padding: 20px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid #F39C12;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <span style="font-size: 1.8em;">ðŸ‘¨â€ðŸ«</span>
                            <span style="font-weight: 600; color: #D68910; font-size: 1.1em;">Coach's Note</span>
                        </div>
                        ${isCoach ? `
                            <textarea class="input-field" rows="3" placeholder="Add motivational note for this workout day..." 
                                      onchange="updateTrainerNote(this.value)" style="margin-bottom: 10px;">${day.trainerNote || ''}</textarea>
                        ` : `
                            <div style="color: #2C3E50; font-size: 1.05em; line-height: 1.6;">${day.trainerNote || 'No note for this day yet.'}</div>
                        `}
                    </div>
                `;
            } else {
                trainerNoteSection.innerHTML = '';
            }
            
            // Update button text
            const btn = document.getElementById('markDayCompleteBtn');
            if (day.completed) {
                btn.textContent = 'âœ“ Completed';
                btn.className = 'btn btn-secondary';
            } else {
                btn.textContent = 'Mark as Complete';
                btn.className = 'btn btn-primary';
            }
            
            renderExercises();
            showPage('dayDetail');
        }
        
        // Render Exercises
        function renderExercises() {
            if (appState.currentDay === null) return;
            
            const day = appState.trainingDays[appState.currentDay];
            const container = document.getElementById('exercisesList');
            const isCoach = appState.userRole === 'coach';
            
            container.innerHTML = '';
            
            day.exercises.forEach((exercise, exIndex) => {
                const exerciseCard = document.createElement('div');
                exerciseCard.className = 'exercise-detail-card';
                
                let html = `
                    <div class="exercise-header">
                        <div class="exercise-name">${exercise.name}</div>
                        ${isCoach ? `<div class="delete-exercise" onclick="deleteExercise(${exIndex})">ðŸ—‘ï¸</div>` : ''}
                    </div>
                    
                    <div class="exercise-inputs">
                        <div class="input-group">
                            <label class="input-label">Sets</label>
                            <input type="number" class="input-field small" value="${exercise.sets}" 
                                   onchange="updateExercise(${exIndex}, 'sets', this.value)" ${isCoach ? '' : 'readonly'}>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Reps</label>
                            <input type="text" class="input-field small" value="${exercise.reps}" 
                                   onchange="updateExercise(${exIndex}, 'reps', this.value)" ${isCoach ? '' : 'readonly'}>
                        </div>
                        <div class="input-group">
                            <label class="input-label">RIR (Trainee)</label>
                            <input type="text" class="input-field small" placeholder="2-3" value="${exercise.rir}" 
                                   onchange="updateExercise(${exIndex}, 'rir', this.value)">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Weight (kg)</label>
                            <input type="text" class="input-field small" placeholder="60" value="${exercise.weight}" 
                                   onchange="updateExercise(${exIndex}, 'weight', this.value)">
                        </div>
                    </div>
                `;
                
                // Coach Note
                if (exercise.coachNote || isCoach) {
                    html += `
                        <div class="notes-section">
                            <div class="notes-header">
                                <label class="input-label">Coach Note</label>
                                <span class="note-badge note-coach">COACH</span>
                            </div>
                            ${isCoach ? `
                                <input type="text" class="input-field small" placeholder="Form tips, technique notes..." 
                                       value="${exercise.coachNote}" onchange="updateExercise(${exIndex}, 'coachNote', this.value)">
                            ` : (exercise.coachNote ? `<div class="note-text">${exercise.coachNote}</div>` : '')}
                        </div>
                    `;
                }
                
                // Trainee Note
                html += `
                    <div class="notes-section">
                        <div class="notes-header">
                            <label class="input-label">Your Note</label>
                            <span class="note-badge note-trainee">TRAINEE</span>
                        </div>
                        <input type="text" class="input-field small" placeholder="How did it feel? Any issues?" 
                               value="${exercise.traineeNote}" onchange="updateExercise(${exIndex}, 'traineeNote', this.value)">
                    </div>
                `;
                
                // Video Section
                html += `
                    <div class="notes-section" style="margin-top: 15px;">
                        <div class="notes-header">
                            <label class="input-label">Form Check Video</label>
                            <span class="note-badge" style="background: #E7F3FF; color: #2196F3;">ðŸ“¹ VIDEO</span>
                        </div>
                        ${exercise.videoUrl ? `
                            <div style="position: relative; margin-bottom: 10px;">
                                <video controls style="width: 100%; max-height: 200px; border-radius: 8px; background: #000;">
                                    <source src="${exercise.videoUrl}" type="video/mp4">
                                </video>
                                <button onclick="removeExerciseVideo(${exIndex})" 
                                        style="position: absolute; top: 8px; right: 8px; background: rgba(231, 76, 60, 0.9); color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 1.2em; display: flex; align-items: center; justify-content: center;">
                                    Ã—
                                </button>
                            </div>
                        ` : ''}
                        <input type="file" id="videoUpload_${exIndex}" accept="video/*" style="display: none" 
                               onchange="handleExerciseVideoUpload(event, ${exIndex})">
                        <button class="btn btn-outline btn-small" onclick="document.getElementById('videoUpload_${exIndex}').click()" style="width: 100%;">
                            ${exercise.videoUrl ? 'ðŸ“¹ Replace Video' : 'ðŸ“¹ Upload Form Video'}
                        </button>
                    </div>
                `;
                
                exerciseCard.innerHTML = html;
                // A: weight progress block
                if(typeof window.buildWeightProgressBlock==="function"){
                    var dayObj=appState.trainingDays[appState.currentDay];
                    var dayName=(dayObj&&dayObj.title)?dayObj.title:("Day "+(appState.currentDay+1));
                    exerciseCard.appendChild(window.buildWeightProgressBlock(dayName,exercise.name,exercise.weight));
                }
                container.appendChild(exerciseCard);
            });
        }
        
        // Handle Exercise Video Upload
        function handleExerciseVideoUpload(event, exIndex) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Check file size (max 50MB)
            if (file.size > 50 * 1024 * 1024) {
                playErrorSound();
                alert('Video file is too large! Please keep it under 50MB.');
                return;
            }
            
            initAudio();
            playSuccessSound();
            
            // Create object URL for the video
            const videoUrl = URL.createObjectURL(file);
            
            // Update exercise with video URL
            if (appState.currentDay !== null) {
                appState.trainingDays[appState.currentDay].exercises[exIndex].videoUrl = videoUrl;
                appState.trainingDays[appState.currentDay].exercises[exIndex].videoFile = file;
                renderExercises();
            }
            
            // Clear input
            event.target.value = '';
        }
        
        // Remove Exercise Video
        function removeExerciseVideo(exIndex) {
            if (confirm('Remove this video?')) {
                initAudio();
                playClickSound();
                
                if (appState.currentDay !== null) {
                    const exercise = appState.trainingDays[appState.currentDay].exercises[exIndex];
                    if (exercise.videoUrl) {
                        URL.revokeObjectURL(exercise.videoUrl);
                    }
                    delete exercise.videoUrl;
                    delete exercise.videoFile;
                    renderExercises();
                }
            }
        }
        
        // Update Exercise
        function updateExercise(exIndex, field, value) {
            if (appState.currentDay === null) return;
            appState.trainingDays[appState.currentDay].exercises[exIndex][field] = value;
        }
        
        // Delete Exercise
        function deleteExercise(exIndex) {
            if (confirm('Delete this exercise?')) {
                initAudio();
                playClickSound();
                
                appState.trainingDays[appState.currentDay].exercises.splice(exIndex, 1);
                renderExercises();
            }
        }
        
        // Toggle Day Complete
        function toggleDayComplete() {
            if (appState.currentDay === null) return;
            
            initAudio();
            
            const day = appState.trainingDays[appState.currentDay];
            day.completed = !day.completed;
            
            // Update button
            const btn = document.getElementById('markDayCompleteBtn');
            if (day.completed) {
                btn.textContent = 'âœ“ Completed';
                btn.className = 'btn btn-secondary';
                appState.workoutsCompleted++;
                playCompleteSound(); // Sound effect
            } else {
                btn.textContent = 'Mark as Complete';
                btn.className = 'btn btn-primary';
                appState.workoutsCompleted--;
                playClickSound(); // Sound effect
            }
            
            calculateScore();
            renderTrainingDays();
        }
        
        // Show Add Day Modal
        function showAddDayModal() {
            openModal('addDayModal');
        }
        
        // Add New Day
        function addNewDay() {
            const letter = document.getElementById('newDayLetter').value.toUpperCase();
            const title = document.getElementById('newDayTitle').value;
            
            if (!letter || !title) {
                playErrorSound();
                alert('Please fill in all fields');
                return;
            }
            
            initAudio();
            playSuccessSound();
            
            appState.trainingDays.push({
                letter: letter,
                title: title,
                completed: false,
                trainerNote: '',
                exercises: []
            });
            
            renderTrainingDays();
            closeModal('addDayModal');
            
            // Clear inputs
            document.getElementById('newDayLetter').value = '';
            document.getElementById('newDayTitle').value = '';
        }
        
        // Show Add Exercise Modal
        function showAddExerciseModal() {
            openModal('addExerciseModal');
        }
        
        // Add New Exercise
        function addNewExercise() {
            if (appState.currentDay === null) return;
            
            const name = document.getElementById('newExerciseName').value;
            const sets = document.getElementById('newExerciseSets').value;
            const reps = document.getElementById('newExerciseReps').value;
            
            if (!name || !sets || !reps) {
                playErrorSound();
                alert('Please fill in all fields');
                return;
            }
            
            initAudio();
            playSuccessSound();
            
            appState.trainingDays[appState.currentDay].exercises.push({
                name: name,
                sets: parseInt(sets),
                reps: reps,
                rir: '',
                weight: '',
                coachNote: '',
                traineeNote: ''
            });
            
            renderExercises();
            closeModal('addExerciseModal');
            
            // Clear inputs
            document.getElementById('newExerciseName').value = '';
            document.getElementById('newExerciseSets').value = '';
            document.getElementById('newExerciseReps').value = '';
        }
        
        // Edit Day Name
        function editDayName() {
            if (appState.currentDay === null) return;
            
            const day = appState.trainingDays[appState.currentDay];
            const newLetter = prompt('Day Letter:', day.letter);
            const newTitle = prompt('Day Title:', day.title);
            
            if (newLetter) day.letter = newLetter.toUpperCase();
            if (newTitle) day.title = newTitle;
            
            document.getElementById('detailDayLetter').textContent = day.letter;
            document.getElementById('detailDayTitle').textContent = day.title;
            renderTrainingDays();
        }
        
        // Update Trainer Note
        function updateTrainerNote(note) {
            if (appState.currentDay === null || appState.userRole !== 'coach') return;
            appState.trainingDays[appState.currentDay].trainerNote = note;
        }
        
        // Calculate Score
        function calculateScore() {
            const trainingScore = (appState.workoutsCompleted / appState.totalWorkouts) * 40;
            const nutritionScore = appState.nutritionScore * 4;
            const sleepScore = (appState.sleepAverage / 8) * 20;
            
            appState.score = Math.round(trainingScore + nutritionScore + sleepScore);
            updateScoreDisplay();
        }
        
        // Update Score Display
        function updateScoreDisplay() {
            const scoreValue = document.getElementById('scoreValue');
            const scoreStatus = document.getElementById('scoreStatus');
            
            scoreValue.textContent = appState.score;
            scoreValue.style.color = getScoreColor(appState.score);
            
            if (appState.score >= 90) {
                scoreStatus.textContent = 'ðŸ”¥ Elite Performance';
                scoreStatus.className = 'score-status status-elite';
            } else if (appState.score >= 75) {
                scoreStatus.textContent = 'âœ… On Track';
                scoreStatus.className = 'score-status status-track';
            } else {
                scoreStatus.textContent = 'âš ï¸ Needs Attention';
                scoreStatus.className = 'score-status status-attention';
            }
            
            document.getElementById('workoutsCompleted').textContent = appState.workoutsCompleted;
            document.getElementById('nutritionScore').textContent = appState.nutritionScore;
            document.getElementById('sleepAvg').textContent = appState.sleepAverage;
        }
        
        // Get Score Color
        function getScoreColor(score) {
            if (score >= 90) return '#27AE60';
            if (score >= 75) return '#F39C12';
            return '#E74C3C';
        }
        
        // Update Mission Rating
        function updateMissionRating(value) {
            appState.missionRating = parseInt(value);
            document.getElementById('missionRating').textContent = value;
            document.getElementById('missionRating').style.color = getScoreColor(value * 10);
        }
        
        // Save Mission Rating
        function saveMissionRating() {
            initAudio();
            playCompleteSound();
            
            appState.nutritionScore = appState.missionRating;
            calculateScore();
            alert(`âœ… Mission rating saved: ${appState.missionRating}/10`);
        }
        
        // Save Sleep
        function saveSleep() {
            initAudio();
            playCompleteSound();
            
            const sleepInput = document.getElementById('sleepInput');
            appState.sleepAverage = parseFloat(sleepInput.value) || 7.5;
            calculateScore();
            alert(`âœ… Sleep updated: ${appState.sleepAverage} hours`);
        }
        
        // Update Mission (Coach)
        function updateMission() {
            const newMission = document.getElementById('editMissionInput').value;
            if (newMission.trim()) {
                initAudio();
                playSuccessSound();
                
                appState.currentMission = newMission;
                document.getElementById('currentMission').textContent = newMission;
                document.getElementById('missionText').textContent = newMission;
                document.getElementById('editMissionInput').value = '';
                alert('âœ… Mission updated!');
            }
        }
        
        // Send Message
        function sendMessage() {
            const input = document.getElementById('traineeChatInput');
            const message = input.value.trim();
            
            if (message) {
                initAudio();
                playClickSound();
                
                const messagesContainer = document.getElementById('traineeChatMessages');
                const isCoach = appState.userRole === 'coach';
                
                const messageEl = document.createElement('div');
                messageEl.className = `message ${isCoach ? 'coach' : 'trainee'}`;
                messageEl.innerHTML = `
                    <div class="message-sender">${isCoach ? 'Coach' : 'You'}</div>
                    <div class="message-text">${message}</div>
                    <div class="message-time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                `;
                
                messagesContainer.appendChild(messageEl);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                
                input.value = '';
            }
        }
        
        // Modal Functions
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }
        
        
        // ========== CALL SCHEDULING FUNCTIONS ==========
        
        // Render Call Slots
        function renderCallSlots() {
            const container = document.getElementById('callSlotsContainer');
            const isCoach = appState.userRole === 'coach';
            
            // Show/hide add button for coach
            document.getElementById('addSlotBtn').style.display = isCoach ? 'block' : 'none';
            
            // Update description
            if (isCoach) {
                document.getElementById('callsDescription').textContent = 'Manage available time slots for trainee calls';
            } else {
                document.getElementById('callsDescription').textContent = 'Book your weekly call with the coach (one per week)';
            }
            
            // Check if user has booked slot
            const userBooking = appState.callSlots.find(slot => slot.bookedBy === 'John Doe');
            if (userBooking && !isCoach) {
                document.getElementById('bookedCallCard').style.display = 'block';
                document.getElementById('bookedTime').textContent = `${userBooking.day} at ${userBooking.time}`;
                document.getElementById('bookedDate').textContent = `${userBooking.duration} minutes`;
                appState.currentUserBookedSlot = userBooking.id;
            } else {
                document.getElementById('bookedCallCard').style.display = 'none';
                appState.currentUserBookedSlot = null;
            }
            
            container.innerHTML = '';
            
            // Group slots by day
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const slotsByDay = {};
            
            days.forEach(day => {
                slotsByDay[day] = appState.callSlots.filter(slot => slot.day === day);
            });
            
            // Render slots by day
            days.forEach(day => {
                const daySlots = slotsByDay[day];
                if (daySlots.length === 0 && !isCoach) return;
                
                const dayCard = document.createElement('div');
                dayCard.style.marginBottom = '20px';
                
                const dayTitle = document.createElement('h3');
                dayTitle.style.color = '#1E8449';
                dayTitle.style.marginBottom = '12px';
                dayTitle.style.fontSize = '1.1em';
                dayTitle.textContent = day;
                dayCard.appendChild(dayTitle);
                
                if (daySlots.length === 0) {
                    const noSlots = document.createElement('p');
                    noSlots.style.color = '#7f8c8d';
                    noSlots.style.fontStyle = 'italic';
                    noSlots.textContent = 'No slots available';
                    dayCard.appendChild(noSlots);
                } else {
                    daySlots.forEach(slot => {
                        const slotCard = document.createElement('div');
                        slotCard.style.background = slot.bookedBy ? '#f5f7f6' : '#E8F5E9';
                        slotCard.style.padding = '15px';
                        slotCard.style.borderRadius = '12px';
                        slotCard.style.marginBottom = '10px';
                        slotCard.style.border = slot.bookedBy ? '2px solid #95a5a6' : '2px solid #2ECC71';
                        
                        const slotHeader = document.createElement('div');
                        slotHeader.style.display = 'flex';
                        slotHeader.style.justifyContent = 'space-between';
                        slotHeader.style.alignItems = 'center';
                        
                        const slotInfo = document.createElement('div');
                        const timeText = document.createElement('div');
                        timeText.style.fontSize = '1.1em';
                        timeText.style.fontWeight = 'bold';
                        timeText.style.color = '#1E8449';
                        timeText.textContent = `${slot.time} (${slot.duration} min)`;
                        slotInfo.appendChild(timeText);
                        
                        if (slot.bookedBy) {
                            const bookedText = document.createElement('div');
                            bookedText.style.fontSize = '0.85em';
                            bookedText.style.color = '#7f8c8d';
                            bookedText.style.marginTop = '5px';
                            bookedText.textContent = isCoach ? `Booked by: ${slot.bookedBy}` : 'Booked';
                            slotInfo.appendChild(bookedText);
                        }
                        
                        slotHeader.appendChild(slotInfo);
                        
                        // Action buttons
                        const actions = document.createElement('div');
                        
                        if (isCoach) {
                            // Coach can delete any slot
                            const deleteBtn = document.createElement('button');
                            deleteBtn.className = 'btn btn-danger btn-small';
                            deleteBtn.textContent = 'ðŸ—‘ï¸';
                            deleteBtn.onclick = () => deleteSlot(slot.id);
                            actions.appendChild(deleteBtn);
                        } else {
                            // Trainee can book available slots
                            if (!slot.bookedBy) {
                                // Check if user already has a booking
                                if (appState.currentUserBookedSlot) {
                                    const disabledBtn = document.createElement('button');
                                    disabledBtn.className = 'btn btn-secondary btn-small';
                                    disabledBtn.textContent = 'One per week';
                                    disabledBtn.disabled = true;
                                    actions.appendChild(disabledBtn);
                                } else {
                                    const bookBtn = document.createElement('button');
                                    bookBtn.className = 'btn btn-primary btn-small';
                                    bookBtn.textContent = 'Book';
                                    bookBtn.onclick = () => bookSlot(slot.id);
                                    actions.appendChild(bookBtn);
                                }
                            } else if (slot.bookedBy === 'John Doe') {
                                const cancelBtn = document.createElement('button');
                                cancelBtn.className = 'btn btn-danger btn-small';
                                cancelBtn.textContent = 'Cancel';
                                cancelBtn.onclick = () => cancelSlotBooking(slot.id);
                                actions.appendChild(cancelBtn);
                            }
                        }
                        
                        slotHeader.appendChild(actions);
                        slotCard.appendChild(slotHeader);
                        dayCard.appendChild(slotCard);
                    });
                }
                
                container.appendChild(dayCard);
            });
        }
        
        // Show Add Slot Modal
        function showAddSlotModal() {
            openModal('addSlotModal');
        }
        
        // Add Time Slot (Coach only)
        function addTimeSlot() {
            if (appState.userRole !== 'coach') return;
            
            const day = document.getElementById('slotDay').value;
            const time = document.getElementById('slotTime').value;
            const duration = parseInt(document.getElementById('slotDuration').value);
            
            if (!time) {
                playErrorSound();
                alert('Please select a time');
                return;
            }
            
            initAudio();
            playSuccessSound();
            
            const newSlot = {
                id: appState.nextSlotId++,
                day: day,
                time: time,
                duration: duration,
                bookedBy: null
            };
            
            appState.callSlots.push(newSlot);
            appState.callSlots.sort((a, b) => {
                const dayOrder = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                const dayDiff = dayOrder.indexOf(a.day) - dayOrder.indexOf(b.day);
                if (dayDiff !== 0) return dayDiff;
                return a.time.localeCompare(b.time);
            });
            
            renderCallSlots();
            closeModal('addSlotModal');
            
            // Clear inputs
            document.getElementById('slotTime').value = '';
        }
        
        // Delete Slot (Coach only)
        function deleteSlot(slotId) {
            if (appState.userRole !== 'coach') return;
            
            const slot = appState.callSlots.find(s => s.id === slotId);
            if (slot && slot.bookedBy) {
                if (!confirm(`This slot is booked by ${slot.bookedBy}. Delete anyway?`)) {
                    return;
                }
            }
            
            initAudio();
            playClickSound();
            
            appState.callSlots = appState.callSlots.filter(s => s.id !== slotId);
            renderCallSlots();
        }
        
        // Book Slot (Trainee)
        function bookSlot(slotId) {
            if (appState.userRole === 'coach') return;
            
            // Check if user already has a booking
            if (appState.currentUserBookedSlot) {
                playErrorSound();
                alert('You can only book one call per week. Cancel your current booking first.');
                return;
            }
            
            const slot = appState.callSlots.find(s => s.id === slotId);
            if (slot && !slot.bookedBy) {
                initAudio();
                playCompleteSound();
                
                slot.bookedBy = 'John Doe'; // Current user
                appState.currentUserBookedSlot = slotId;
                renderCallSlots();
                alert(`âœ… Call booked for ${slot.day} at ${slot.time}!`);
            }
        }
        
        // Cancel Slot Booking (Trainee)
        function cancelSlotBooking(slotId) {
            if (appState.userRole === 'coach') return;
            
            const slot = appState.callSlots.find(s => s.id === slotId);
            if (slot && slot.bookedBy === 'John Doe') {
                if (confirm('Cancel this call?')) {
                    initAudio();
                    playClickSound();
                    
                    slot.bookedBy = null;
                    appState.currentUserBookedSlot = null;
                    renderCallSlots();
                }
            }
        }
        
        // Cancel Call (from booked card)
        function cancelCall() {
            if (appState.currentUserBookedSlot) {
                cancelSlotBooking(appState.currentUserBookedSlot);
            }
        }
        
        
        // ========== SMS NOTIFICATIONS FUNCTIONS ==========
        
        // Render SMS Schedules
        function renderSMSSchedules() {
            const container = document.getElementById('smsScheduleList');
            container.innerHTML = '';
            
            if (appState.smsSchedules.length === 0) {
                container.innerHTML = '<p style="color: #7f8c8d; text-align: center; padding: 20px;">No SMS schedules yet. Create one to start sending automated messages!</p>';
                return;
            }
            
            appState.smsSchedules.forEach(schedule => {
                const scheduleCard = document.createElement('div');
                scheduleCard.style.background = '#E8F5E9';
                scheduleCard.style.padding = '20px';
                scheduleCard.style.borderRadius = '12px';
                scheduleCard.style.marginBottom = '15px';
                scheduleCard.style.borderLeft = '4px solid #2ECC71';
                
                const header = document.createElement('div');
                header.style.display = 'flex';
                header.style.justifyContent = 'space-between';
                header.style.alignItems = 'flex-start';
                header.style.marginBottom = '12px';
                
                const messageBox = document.createElement('div');
                messageBox.style.flex = '1';
                
                const messageText = document.createElement('div');
                messageText.style.fontSize = '1.05em';
                messageText.style.fontWeight = '600';
                messageText.style.color = '#1E8449';
                messageText.style.marginBottom = '10px';
                messageText.textContent = schedule.message;
                messageBox.appendChild(messageText);
                
                const daysText = document.createElement('div');
                daysText.style.fontSize = '0.9em';
                daysText.style.color = '#7f8c8d';
                daysText.innerHTML = `ðŸ“… ${schedule.days.join(', ')} at ${schedule.time}`;
                messageBox.appendChild(daysText);
                
                header.appendChild(messageBox);
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn btn-danger btn-small';
                deleteBtn.textContent = 'ðŸ—‘ï¸';
                deleteBtn.onclick = () => deleteSMSSchedule(schedule.id);
                header.appendChild(deleteBtn);
                
                const testBtn = document.createElement('button');
                testBtn.className = 'btn btn-outline btn-small';
                testBtn.textContent = 'ðŸ“± Test Send';
                testBtn.style.marginTop = '10px';
                testBtn.onclick = () => testSMSSchedule(schedule);
                
                scheduleCard.appendChild(header);
                scheduleCard.appendChild(testBtn);
                container.appendChild(scheduleCard);
            });
        }
        
        // Show Add SMS Modal
        function showAddSMSModal() {
            openModal('addSMSModal');
        }
        
        // Add SMS Schedule
        function addSMSSchedule() {
            const message = document.getElementById('smsMessage').value.trim();
            const time = document.getElementById('smsTime').value;
            
            // Get selected days
            const dayCheckboxes = document.querySelectorAll('.sms-day:checked');
            const days = Array.from(dayCheckboxes).map(cb => cb.value);
            
            if (!message) {
                playErrorSound();
                alert('Please enter a message');
                return;
            }
            
            if (days.length === 0) {
                playErrorSound();
                alert('Please select at least one day');
                return;
            }
            
            initAudio();
            playSuccessSound();
            
            appState.smsSchedules.push({
                id: appState.nextSMSId++,
                message: message,
                days: days,
                time: time
            });
            
            renderSMSSchedules();
            closeModal('addSMSModal');
            
            // Clear form
            document.getElementById('smsMessage').value = '';
            document.getElementById('smsTime').value = '08:00';
            document.querySelectorAll('.sms-day').forEach(cb => cb.checked = false);
        }
        
        // Delete SMS Schedule
        function deleteSMSSchedule(id) {
            if (confirm('Delete this SMS schedule?')) {
                initAudio();
                playClickSound();
                
                appState.smsSchedules = appState.smsSchedules.filter(s => s.id !== id);
                renderSMSSchedules();
            }
        }
        
        // Test SMS Schedule (simulates sending)
        function testSMSSchedule(schedule) {
            initAudio();
            playSMSSound();
            
            // Show notification
            const notification = document.createElement('div');
            notification.style.position = 'fixed';
            notification.style.top = '80px';
            notification.style.left = '50%';
            notification.style.transform = 'translateX(-50%)';
            notification.style.background = 'linear-gradient(135deg, #2ECC71 0%, #27AE60 100%)';
            notification.style.color = 'white';
            notification.style.padding = '15px 25px';
            notification.style.borderRadius = '12px';
            notification.style.boxShadow = '0 4px 20px rgba(46, 204, 113, 0.4)';
            notification.style.zIndex = '1000';
            notification.style.maxWidth = '90%';
            notification.innerHTML = `
                <div style="font-weight: 600; margin-bottom: 5px;">ðŸ“± SMS Sent!</div>
                <div style="font-size: 0.9em;">${schedule.message}</div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.transition = 'opacity 0.5s ease';
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 500);
            }, 3000);
        }
        
        
        // ========== TRAINEE MANAGEMENT FUNCTIONS ==========
        
        // Render Trainees List
        function renderTraineesList() {
            const container = document.getElementById('traineesList');
            container.innerHTML = '';
            
            const currentTrainee = appState.trainees.find(t => t.id === appState.currentTraineeId);
            
            // Update current trainee card
            if (currentTrainee) {
                document.getElementById('currentTraineeName').textContent = currentTrainee.name;
                document.getElementById('currentTraineeStats').textContent = 
                    `${currentTrainee.workoutsCompleted}/${currentTrainee.totalWorkouts} workouts â€¢ Score: ${currentTrainee.score}`;
            }
            
            // Calculate stats
            document.getElementById('totalTrainees').textContent = appState.trainees.length;
            document.getElementById('activeTrainees').textContent = 
                appState.trainees.filter(t => t.status === 'active').length;
            const avgScore = Math.round(
                appState.trainees.reduce((sum, t) => sum + t.score, 0) / appState.trainees.length
            );
            document.getElementById('avgScore').textContent = avgScore;
            document.getElementById('bookedCalls').textContent = 
                appState.callSlots.filter(s => s.bookedBy !== null).length;
            
            // Render trainee cards
            appState.trainees.forEach(trainee => {
                const isCurrent = trainee.id === appState.currentTraineeId;
                
                const traineeCard = document.createElement('div');
                traineeCard.style.background = isCurrent ? '#E8F5E9' : 'white';
                traineeCard.style.padding = '15px';
                traineeCard.style.borderRadius = '12px';
                traineeCard.style.marginBottom = '12px';
                traineeCard.style.border = isCurrent ? '2px solid #2ECC71' : '2px solid #E8F5E9';
                traineeCard.style.cursor = 'pointer';
                traineeCard.style.transition = 'all 0.2s ease';
                traineeCard.onclick = () => switchTrainee(trainee.id);
                
                const statusColors = {
                    'active': '#2ECC71',
                    'attention': '#F39C12',
                    'inactive': '#E74C3C'
                };
                
                const statusText = {
                    'active': 'âœ… Active',
                    'attention': 'âš ï¸ Needs Attention',
                    'inactive': 'âŒ Inactive'
                };
                
                traineeCard.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                        <div style="flex: 1;">
                            <div style="font-size: 1.1em; font-weight: bold; color: #1E8449; margin-bottom: 5px;">
                                ${trainee.name} ${isCurrent ? '(Current)' : ''}
                            </div>
                            <div style="font-size: 0.85em; color: #7f8c8d; margin-bottom: 5px;">
                                ðŸ“§ ${trainee.email}
                            </div>
                            <div style="font-size: 0.85em; color: #7f8c8d;">
                                ðŸ“± ${trainee.phone}
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="background: ${statusColors[trainee.status]}20; color: ${statusColors[trainee.status]}; 
                                        padding: 5px 10px; border-radius: 12px; font-size: 0.75em; font-weight: 600; margin-bottom: 5px;">
                                ${statusText[trainee.status]}
                            </div>
                            <div style="font-size: 1.8em; font-weight: bold; color: ${getScoreColor(trainee.score)};">
                                ${trainee.score}
                            </div>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; padding-top: 10px; border-top: 1px solid #E8F5E9;">
                        <div style="text-align: center;">
                            <div style="font-size: 0.75em; color: #7f8c8d;">Workouts</div>
                            <div style="font-weight: 600; color: #2C3E50;">${trainee.workoutsCompleted}/${trainee.totalWorkouts}</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 0.75em; color: #7f8c8d;">Nutrition</div>
                            <div style="font-weight: 600; color: #2C3E50;">${trainee.nutritionScore}/10</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 0.75em; color: #7f8c8d;">Last Active</div>
                            <div style="font-weight: 600; color: #2C3E50;">${trainee.lastActive}</div>
                        </div>
                    </div>
                    ${isCurrent ? '' : `
                        <button class="btn btn-primary btn-small" style="margin-top: 10px;" onclick="event.stopPropagation(); switchTrainee(${trainee.id})">
                            Switch to ${trainee.name.split(' ')[0]}
                        </button>
                    `}
                `;
                
                container.appendChild(traineeCard);
            });
        }
        
        // Switch Trainee
        function switchTrainee(traineeId) {
            initAudio();
            playSuccessSound();
            
            const trainee = appState.trainees.find(t => t.id === traineeId);
            if (!trainee) return;
            
            appState.currentTraineeId = traineeId;
            
            // Update app state with trainee's data
            appState.score = trainee.score;
            appState.workoutsCompleted = trainee.workoutsCompleted;
            appState.totalWorkouts = trainee.totalWorkouts;
            appState.nutritionScore = trainee.nutritionScore;
            appState.sleepAverage = trainee.sleepAverage;
            
            // Update display name
            document.getElementById('menuUserName').textContent = `Managing: ${trainee.name}`;
            
            renderTraineesList();
            updateScoreDisplay();
            calculateScore();
            
            // Show notification
            const notification = document.createElement('div');
            notification.style.position = 'fixed';
            notification.style.top = '80px';
            notification.style.left = '50%';
            notification.style.transform = 'translateX(-50%)';
            notification.style.background = 'linear-gradient(135deg, #2ECC71 0%, #27AE60 100%)';
            notification.style.color = 'white';
            notification.style.padding = '15px 25px';
            notification.style.borderRadius = '12px';
            notification.style.boxShadow = '0 4px 20px rgba(46, 204, 113, 0.4)';
            notification.style.zIndex = '1000';
            notification.style.fontWeight = '600';
            notification.textContent = `âœ… Now managing: ${trainee.name}`;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.transition = 'opacity 0.5s ease';
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 500);
            }, 2000);
        }
        
        // View Trainee Dashboard
        function viewTraineeDashboard() {
            showPage('traineeDashboardPage');
        }
        
        // Show Add Trainee Modal
        function showAddTraineeModal() {
            openModal('addTraineeModal');
        }
        
        // Add New Trainee
        function addNewTrainee() {
            const name = document.getElementById('newTraineeName').value.trim();
            const email = document.getElementById('newTraineeEmail').value.trim();
            const phone = document.getElementById('newTraineePhone').value.trim();
            const program = document.getElementById('newTraineeProgram').value;
            
            if (!name || !email || !phone) {
                playErrorSound();
                alert('Please fill in all required fields');
                return;
            }
            
            initAudio();
            playCompleteSound();
            
            const newTrainee = {
                id: appState.nextTraineeId++,
                name: name,
                email: email,
                phone: phone,
                score: 0,
                workoutsCompleted: 0,
                totalWorkouts: 5,
                nutritionScore: 0,
                sleepAverage: 0,
                lastActive: 'Just joined',
                joinDate: new Date().toISOString().split('T')[0],
                status: 'active',
                program: program
            };
            
            appState.trainees.push(newTrainee);
            renderTraineesList();
            closeModal('addTraineeModal');
            
            // Clear inputs
            document.getElementById('newTraineeName').value = '';
            document.getElementById('newTraineeEmail').value = '';
            document.getElementById('newTraineePhone').value = '';
            
            alert(`âœ… ${name} has been added as a new trainee!`);
        }
        
        
        // ========== CHAT FUNCTIONS ==========
        
        // Render Chat based on role
        function renderChat() {
            const isCoach = appState.userRole === 'coach';
            
            document.getElementById('traineeChat').style.display = isCoach ? 'none' : 'block';
            document.getElementById('coachChat').style.display = isCoach ? 'block' : 'none';
            
            if (isCoach) {
                renderTraineeListForChat();
            } else {
                renderTraineeMessages();
            }
        }
        
        // Render trainee's messages (trainee view)
        function renderTraineeMessages() {
            const container = document.getElementById('traineeChatMessages');
            const messages = appState.chatMessages[1] || []; // Trainee is always ID 1 (John Doe)
            
            container.innerHTML = '';
            
            messages.forEach(msg => {
                const messageEl = document.createElement('div');
                messageEl.className = `message ${msg.from}`;
                messageEl.innerHTML = `
                    <div class="message-sender">${msg.from === 'coach' ? 'Coach' : 'You'}</div>
                    <div class="message-text">${msg.message}</div>
                    <div class="message-time">${msg.time}</div>
                `;
                container.appendChild(messageEl);
            });
            
            container.scrollTop = container.scrollHeight;
        }
        
        // Send trainee message
        function sendTraineeMessage() {
            const input = document.getElementById('traineeChatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            initAudio();
            playClickSound();
            
            // Add message to trainee's chat
            if (!appState.chatMessages[1]) appState.chatMessages[1] = [];
            appState.chatMessages[1].push({
                from: 'trainee',
                message: message,
                time: new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })
            });
            
            renderTraineeMessages();
            input.value = '';
        }
        
        // Render trainee list for coach chat
        function renderTraineeListForChat() {
            const container = document.getElementById('traineeListChat');
            container.innerHTML = '';
            
            appState.trainees.forEach(trainee => {
                const messages = appState.chatMessages[trainee.id] || [];
                const lastMessage = messages.length > 0 ? messages[messages.length - 1] : null;
                const unreadCount = messages.filter(m => m.from === 'trainee' && !m.read).length;
                
                const traineeItem = document.createElement('div');
                traineeItem.style.padding = '15px 20px';
                traineeItem.style.cursor = 'pointer';
                traineeItem.style.borderBottom = '1px solid #E8F5E9';
                traineeItem.style.transition = 'background 0.2s ease';
                traineeItem.style.background = appState.selectedChatTraineeId === trainee.id ? '#E8F5E9' : 'white';
                
                traineeItem.onmouseover = () => {
                    if (appState.selectedChatTraineeId !== trainee.id) {
                        traineeItem.style.background = '#F5F7F6';
                    }
                };
                traineeItem.onmouseout = () => {
                    if (appState.selectedChatTraineeId !== trainee.id) {
                        traineeItem.style.background = 'white';
                    }
                };
                
                traineeItem.onclick = () => selectChatTrainee(trainee.id);
                
                const initial = trainee.name.charAt(0).toUpperCase();
                const preview = lastMessage ? lastMessage.message.substring(0, 35) + (lastMessage.message.length > 35 ? '...' : '') : 'No messages yet';
                
                traineeItem.innerHTML = `
                    <div style="display: flex; gap: 12px; align-items: center;">
                        <div style="width: 45px; height: 45px; border-radius: 50%; background: linear-gradient(135deg, #2ECC71 0%, #27AE60 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 1.2em; flex-shrink: 0;">
                            ${initial}
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 3px;">
                                <div style="font-weight: 600; color: #1E8449; font-size: 0.95em;">${trainee.name.split(' ')[0]}</div>
                                ${unreadCount > 0 ? `
                                    <div style="background: #2ECC71; color: white; border-radius: 10px; padding: 2px 7px; font-size: 0.7em; font-weight: 600;">
                                        ${unreadCount}
                                    </div>
                                ` : ''}
                            </div>
                            <div style="font-size: 0.85em; color: #7f8c8d; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                ${preview}
                            </div>
                        </div>
                    </div>
                `;
                
                container.appendChild(traineeItem);
            });
        }
        
        // Select trainee in chat
        function selectChatTrainee(traineeId) {
            initAudio();
            playBuddySound();
            
            appState.selectedChatTraineeId = traineeId;
            const trainee = appState.trainees.find(t => t.id === traineeId);
            
            if (!trainee) return;
            
            // Update header
            document.getElementById('chatHeader').style.display = 'block';
            document.getElementById('chatHeaderInitial').textContent = trainee.name.charAt(0).toUpperCase();
            document.getElementById('chatHeaderName').textContent = trainee.name;
            document.getElementById('chatHeaderStatus').textContent = `Last active: ${trainee.lastActive}`;
            
            // Show input
            document.getElementById('coachChatInput').style.display = 'block';
            
            // Render messages
            renderCoachMessages(traineeId);
            
            // Mark messages as read
            if (appState.chatMessages[traineeId]) {
                appState.chatMessages[traineeId].forEach(msg => msg.read = true);
            }
            
            // Re-render trainee list to update unread count
            renderTraineeListForChat();
        }
        
        // Render coach messages for selected trainee
        function renderCoachMessages(traineeId) {
            const container = document.getElementById('coachChatMessages');
            const messages = appState.chatMessages[traineeId] || [];
            
            container.innerHTML = '';
            
            if (messages.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #7f8c8d; padding: 40px 20px;">
                        <div style="font-size: 2.5em; margin-bottom: 10px;">ðŸ‘‹</div>
                        <div style="font-size: 1em;">Start the conversation!</div>
                    </div>
                `;
                return;
            }
            
            messages.forEach(msg => {
                const isCoach = msg.from === 'coach';
                const messageEl = document.createElement('div');
                messageEl.style.display = 'flex';
                messageEl.style.justifyContent = isCoach ? 'flex-end' : 'flex-start';
                messageEl.style.marginBottom = '12px';
                
                messageEl.innerHTML = `
                    <div style="max-width: 70%; background: ${isCoach ? 'linear-gradient(135deg, #2ECC71 0%, #27AE60 100%)' : 'white'}; 
                                color: ${isCoach ? 'white' : '#2C3E50'}; padding: 10px 15px; border-radius: ${isCoach ? '18px 18px 4px 18px' : '18px 18px 18px 4px'}; 
                                box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div style="margin-bottom: 4px;">${msg.message}</div>
                        <div style="font-size: 0.75em; opacity: 0.8; text-align: right;">${msg.time}</div>
                    </div>
                `;
                
                container.appendChild(messageEl);
            });
            
            container.scrollTop = container.scrollHeight;
        }
        
        // Send coach message
        function sendCoachMessage() {
            if (!appState.selectedChatTraineeId) return;
            
            const input = document.getElementById('coachMessageInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            initAudio();
            playClickSound();
            
            // Add message
            if (!appState.chatMessages[appState.selectedChatTraineeId]) {
                appState.chatMessages[appState.selectedChatTraineeId] = [];
            }
            
            appState.chatMessages[appState.selectedChatTraineeId].push({
                from: 'coach',
                message: message,
                time: new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }),
                read: true
            });
            
            renderCoachMessages(appState.selectedChatTraineeId);
            renderTraineeListForChat();
            input.value = '';
        }
        
        // ========== END CHAT

        // ========== GLOBAL SCOPE BRIDGE ==========
        // All functions called from inline onclick="..." attributes must be on window.
        // Legacy non-module <script> functions are local to the script block in some
        // environments; explicitly assigning them to window guarantees inline handlers
        // can always find them, regardless of module vs non-module script context.

        // â€” Page navigation â€”
        window.showPage             = showPage;
        window.goBack               = goBack;
        window.showPageDirect       = showPageDirect;
        window.goToDashboard        = goToDashboard;
        window.toggleMenu           = toggleMenu;

        // â€” Auth flow â€” real implementations set by window.X = async function() in the module block.
        // Legacy-script stub so inline onclick="" attributes don't throw before module loads:
        if (!window.completeTraineeSignup) window.completeTraineeSignup = completeTraineeSignup;
        // completeCoachSignup / loginAsTrainee / loginAsCoach / logout have no legacy stub â€”
        // they are defined entirely in the module block and are safe because the module
        // runs before any user interaction can invoke them.

        // â€” Signup / role selection â€”
        window.selectSignupType     = selectSignupType;
        window.showTraineeLogin     = showTraineeLogin;
        window.showCoachLogin       = showCoachLogin;
        window.verifyCode           = verifyCode;
        window.moveToNext           = moveToNext;
        window.moveToPrev           = moveToPrev;

        // â€” Training program â€”
        window.toggleDayComplete    = toggleDayComplete;
        window.openDayDetail        = openDayDetail;
        window.showAddDayModal      = showAddDayModal;
        window.addNewDay            = addNewDay;
        window.editDayName          = editDayName;
        window.showAddExerciseModal = showAddExerciseModal;
        window.addNewExercise       = addNewExercise;
        window.deleteExercise       = deleteExercise;
        window.removeExerciseVideo  = removeExerciseVideo;

        // â€” Missions / score â€”
        window.saveMissionRating    = saveMissionRating;
        window.saveSleep            = saveSleep;
        window.updateMission        = updateMission;
        window.updateMissionRating  = updateMissionRating;

        // â€” Calls / scheduling â€”
        window.showAddSlotModal     = showAddSlotModal;
        window.addTimeSlot          = addTimeSlot;
        window.cancelCall           = cancelCall;
        window.deleteSlot           = deleteSlot;
        window.bookSlot             = bookSlot;
        window.cancelSlotBooking    = cancelSlotBooking;

        // â€” SMS notifications â€”
        window.showAddSMSModal      = showAddSMSModal;
        window.addSMSSchedule       = addSMSSchedule;
        window.deleteSMSSchedule    = deleteSMSSchedule;
        window.testSMSSchedule      = testSMSSchedule;

        // â€” Trainees management â€”
        window.showAddTraineeModal  = showAddTraineeModal;
        window.addNewTrainee        = addNewTrainee;
        window.switchTrainee        = switchTrainee;
        window.viewTraineeDashboard = viewTraineeDashboard;

        // â€” Chat â€”
        window.sendTraineeMessage   = sendTraineeMessage;
        window.sendCoachMessage     = sendCoachMessage;
        window.selectChatTrainee    = selectChatTrainee;

        // â€” Modals â€”
        window.openModal            = openModal;
        window.closeModal           = closeModal;

        // â€” Misc â€”
        window.updateUI             = updateUI;
        window.renderCoachDashboard = renderCoachDashboard;
        window.uploadTraineeVideo   = uploadTraineeVideo;
        window.uploadCoachVideo     = uploadCoachVideo;
        window.sendMessage          = sendMessage;
        window.switchToTrainee      = switchToTrainee;
        window.attemptSwitchRole    = attemptSwitchRole;
        window.showBuddySpeech      = showBuddySpeech;
        window.hideBuddySpeech      = hideBuddySpeech;
        window.initApp              = initApp;
        window.normalizeEmail       = normalizeEmail;

        // === Shared localStorage utils ===
        function loadJSON(key,fb){
            try{return JSON.parse(localStorage.getItem(key))||fb;}catch(e){return fb;}
        }
        function saveJSON(key,val){
            try{localStorage.setItem(key,JSON.stringify(val));}catch(e){}
        }
        function clamp(n,lo,hi){return Math.max(lo,Math.min(hi,n));}
        function getUID(){var a=window.fb&&window.fb.auth&&window.fb.auth.currentUser;return a?a.uid:"guest";}

        // === A: Per-exercise weight progress ===
        function makeExerciseKey(d,e){return getUID()+"::"+d+"::"+e;}
        function getExerciseProgress(k){
            var s=loadJSON("exercise_progress_v1",{});
            return s[k]||{start:0,current:0,goal:100,updatedAt:0};
        }
        function setExerciseProgress(k,obj){
            var s=loadJSON("exercise_progress_v1",{});
            s[k]=Object.assign({},obj,{updatedAt:Date.now()});
            saveJSON("exercise_progress_v1",s);
        }
        function wpBarColor(p){return p>=0.85?"#2ecc71":p>=0.5?"#f7b731":"#ff5a5f";}
        function wpCalcPct(s,c,g){if(g<=s)return 0;return clamp((c-s)/(g-s),0,1);}
        function updateWpUI(wrap,prog){
            var bar=wrap.querySelector("[data-wp-bar]"),txt=wrap.querySelector("[data-wp-text]");
            var pct=wpCalcPct(prog.start,prog.current,prog.goal);
            if(bar){bar.style.width=(pct*100).toFixed(1)+"%";bar.style.background=wpBarColor(pct);}
            if(txt)txt.textContent=(prog.current||0)+" / "+(prog.goal||0)+" kg";
        }
        window.buildWeightProgressBlock=function(dayName,exerciseName,existingWeight){
            var key=makeExerciseKey(dayName,exerciseName);
            var prog=getExerciseProgress(key);
            if(prog.current===0&&existingWeight){
                var w=parseFloat(existingWeight)||0;
                if(w>0)prog={start:w,current:w,goal:Math.round(w*1.25/2.5)*2.5,updatedAt:0};
            }
            var wrap=document.createElement("div");
            wrap.className="weight-progress-wrap";
            wrap.innerHTML=
                '<div class="wp-row"><span>Weight Progress</span><span data-wp-text>0 / 0 kg</span></div>'+
                '<div class="wp-track"><div data-wp-bar></div></div>'+
                '<div class="wp-inputs">'+
                '<input data-wp-current type="number" min="0" step="0.5" placeholder="Current kg" class="wp-inp" value="'+(prog.current||"")+'">'+
                '<input data-wp-goal type="number" min="0" step="0.5" placeholder="Goal kg" class="wp-inp wp-goal-inp" value="'+(prog.goal||"")+'">'+
                '<button data-wp-save type="button" class="btn btn-secondary wp-save">Save</button>'+
                '</div><div data-wp-saved>Saved</div>';
            updateWpUI(wrap,prog);
            wrap.querySelector("[data-wp-save]").addEventListener("click",function(){
                var ci=wrap.querySelector("[data-wp-current]"),gi=wrap.querySelector("[data-wp-goal]"),se=wrap.querySelector("[data-wp-saved]");
                var cur=parseFloat(ci.value)||0,gol=parseFloat(gi.value)||0;
                var st=getExerciseProgress(key);var start=st.start||0;
                if(start===0&&cur>0)start=cur;
                var upd={start:start,current:cur,goal:gol};
                setExerciseProgress(key,upd);updateWpUI(wrap,upd);
                if(se){se.style.display="block";setTimeout(function(){se.style.display="none";},1200);}
            });
            return wrap;
        };

        // === B: Bodyweight progress ===
        function loadBWProgress(){
            var s=loadJSON("bodyweight_progress_v1",{});
            return s[getUID()]||{start:0,current:0,goal:0,updatedAt:0};
        }
        function saveBWProgress(obj){
            var s=loadJSON("bodyweight_progress_v1",{});
            s[getUID()]=Object.assign({},obj,{updatedAt:Date.now()});
            saveJSON("bodyweight_progress_v1",s);
        }
        function bwCalcPct(s,c,g){
            if(s===g||s===0||g===0||c===0)return 0;
            if(g<s)return clamp((s-c)/(s-g),0,1);
            return clamp((c-s)/(g-s),0,1);
        }
        function refreshBWUI(){
            var prog=loadBWProgress();
            var kvEl=document.getElementById("bwKV");
            var barEl=document.querySelector("#bwProgressCard [data-bw-bar]");
            var curIn=document.getElementById("bwCurInput");
            var goalIn=document.getElementById("bwGoalInput");
            if(!kvEl)return;
            kvEl.textContent="Current: "+(prog.current||"-")+" kg  |  Goal: "+(prog.goal||"-")+" kg";
            if(barEl){
                var pct=bwCalcPct(prog.start,prog.current,prog.goal);
                barEl.style.width=(pct*100).toFixed(1)+"%";
                barEl.style.background=wpBarColor(pct);
            }
            if(curIn&&!curIn.value)curIn.value=prog.current||"";
            if(goalIn&&!goalIn.value)goalIn.value=prog.goal||"";
        }
        function saveBodyweight(){
            var curIn=document.getElementById("bwCurInput");
            var goalIn=document.getElementById("bwGoalInput");
            var savedEl=document.getElementById("bwSavedMsg");
            var current=parseFloat((curIn&&curIn.value)||0)||0;
            var goal=parseFloat((goalIn&&goalIn.value)||0)||0;
            var prev=loadBWProgress();
            var start=(prev.start===0&&current>0)?current:(prev.start||current);
            saveBWProgress({start:start,current:current,goal:goal});
            refreshBWUI();
            if(savedEl){savedEl.style.display="block";setTimeout(function(){savedEl.style.display="none";},1200);}
        }
        window.saveBodyweight=saveBodyweight;
        window.refreshBWUI=refreshBWUI;

        // === C: Lobby music ===
        function loadMusicSettings(){return loadJSON("music_settings_v1",{enabled:true,volume:0.25});}
        function saveMusicSettings(obj){saveJSON("music_settings_v1",obj);}
        function startLobbyMusic(){
            var audio=document.getElementById("lobbyMusic");
            var panel=document.getElementById("lobbyMusicPanel");
            var banner=document.getElementById("musicEnableBanner");
            var btn=document.getElementById("musicToggleBtn");
            var slider=document.getElementById("musicVolSlider");
            if(!audio)return;
            var cfg=loadMusicSettings();
            if(!cfg.enabled){if(panel)panel.style.display="block";return;}
            audio.volume=cfg.volume;
            if(slider)slider.value=Math.round(cfg.volume*100);
            if(panel)panel.style.display="block";
            audio.play().then(function(){
                if(banner)banner.style.display="none";
                if(btn)btn.textContent="On";
            }).catch(function(){
                if(banner)banner.style.display="block";
                if(btn)btn.textContent="Off";
                console.info("Lobby music autoplay blocked. Waiting for user gesture.");
            });
        }
        function stopLobbyMusic(){
            var audio=document.getElementById("lobbyMusic");
            var panel=document.getElementById("lobbyMusicPanel");
            var banner=document.getElementById("musicEnableBanner");
            var btn=document.getElementById("musicToggleBtn");
            if(audio){audio.pause();audio.currentTime=0;}
            if(panel)panel.style.display="none";
            if(banner)banner.style.display="none";
            if(btn)btn.textContent="Off";
        }
        function toggleLobbyMusic(){
            var audio=document.getElementById("lobbyMusic");
            var banner=document.getElementById("musicEnableBanner");
            var btn=document.getElementById("musicToggleBtn");
            var cfg=loadMusicSettings();
            if(!audio)return;
            if(audio.paused){
                audio.play().then(function(){cfg.enabled=true;saveMusicSettings(cfg);
                    if(btn)btn.textContent="On";
                    if(banner)banner.style.display="none";
                }).catch(function(){if(banner)banner.style.display="block";});
            }else{
                audio.pause();cfg.enabled=false;saveMusicSettings(cfg);
                if(btn)btn.textContent="Off";
            }
        }
        function setLobbyVolume(v){
            var audio=document.getElementById("lobbyMusic");
            var cfg=loadMusicSettings();
            if(audio)audio.volume=v;
            cfg.volume=v;saveMusicSettings(cfg);
        }
        function userEnableMusic(){
            var banner=document.getElementById("musicEnableBanner");
            var cfg=loadMusicSettings();
            cfg.enabled=true;saveMusicSettings(cfg);
            startLobbyMusic();
            if(banner)banner.style.display="none";
        }
        window.toggleLobbyMusic=toggleLobbyMusic;
        window.setLobbyVolume=setLobbyVolume;
        window.userEnableMusic=userEnableMusic;
        window.startLobbyMusic=startLobbyMusic;
        window.stopLobbyMusic=stopLobbyMusic;

        // ========== END GLOBAL SCOPE BRIDGE ==========

        // â”€â”€ Mini debug helper (Task 3) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function mini(msg) {
            const el = document.getElementById('miniDebug');
            if (el) el.textContent = 'debug: ' + msg;
        }
        window.mini = mini;

        // â”€â”€ Trainee signup button wiring (Task 5) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        document.addEventListener('DOMContentLoaded', () => {
            const btn = document.getElementById('traineeSignupSubmitBtn');
            if (!btn) { mini('ERROR: button not found'); return; }
            mini('button wired âœ…');
            btn.addEventListener('click', async () => {
                mini('clicked âœ…');
                try {
                    await window.completeTraineeSignup();
                    mini('signup finished âœ…');
                } catch (e) {
                    mini('signup crash: ' + (e?.message || e));
                    console.error('signup crash', e);
                }
            });
        });
    </script>


    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
        createUserWithEmailAndPassword,
        signInWithEmailAndPassword,
        signOut
      } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
      import {
        getFirestore,
        doc,
        getDoc,
        setDoc,
        serverTimestamp
      } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

      // â”€â”€ Firebase config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // No analytics â€” measurementId intentionally omitted
      const firebaseConfig = {
        apiKey:            "AIzaSyD6MtE3pCRjBzz0dPucD3DyUFMsSIVy9Kg",
        authDomain:        "segev-3fff9.firebaseapp.com",
        projectId:         "segev-3fff9",
        storageBucket:     "segev-3fff9.firebasestorage.app",
        messagingSenderId: "354962257162",
        appId:             "1:354962257162:web:5aa45a03a55896359c76f3"
      };

      // â”€â”€ Firebase init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // const fb = (window.fb = {}) declares fb in module scope AND sets window.fb.
      // Without this pattern the bare `fb` identifier used in auth functions would
      // fall through to an undefined outer variable and crash on "reading 'app'".
      const fb = (window.fb = {});
      fb.app  = initializeApp(firebaseConfig);
      fb.auth = getAuth(fb.app);
      fb.db   = getFirestore(fb.app);
      window.__FIREBASE_READY__ = true;

      // â”€â”€ Bridge: expose Firebase functions + auth/db to non-module scripts â”€â”€
      // Regular <script> blocks cannot import from ES modules.
      // window.FirebaseFns is the single handoff point.
      window.FirebaseFns = {
        auth: fb.auth,
        db:   fb.db,
        createUserWithEmailAndPassword,
        signInWithEmailAndPassword,
        signOut,
        doc,
        getDoc,
        setDoc,
        serverTimestamp
      };

          // â”€â”€ Auth-in-progress flag â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          // Set true while a signup/login async flow is running.
          // onAuthStateChanged checks this and skips re-routing when set, preventing
          // the race where the new user is kicked back to /signup before setDoc completes.
          let _authInProgress = false;

          // â”€â”€ Internal helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          const _NOT_READY_MSG =
            'âš ï¸ Firebase config missing. Open Firebase Console and copy firebaseConfig.';

          function _fbGuard(errorElId) {
            if (!window.__FIREBASE_READY__) {
              const e = document.getElementById(errorElId);
              if (e) { e.textContent = _NOT_READY_MSG; e.style.display = 'block'; }
              else { alert(_NOT_READY_MSG); }
              return false;
            }
            return true;
          }
          function _showErr(elId, msg) {
            const e = document.getElementById(elId);
            if (e) { e.textContent = msg; e.style.display = 'block'; }
            else { alert(msg); }
          }
          function _clearErr(elId) {
            const e = document.getElementById(elId);
            if (e) { e.textContent = ''; e.style.display = 'none'; }
          }
          function _sound(fn) {
            if (typeof initAudio === 'function') initAudio();
            if (typeof window[fn] === 'function') window[fn]();
          }
          function _routeCoach(profile) {
            appState.userRole = 'coach';
            const menuUserName = document.getElementById('menuUserName');
            const menuUserRole = document.getElementById('menuUserRole');
            if (menuUserName) menuUserName.textContent = profile.name || '';
            if (menuUserRole) menuUserRole.textContent = 'Coach';
            const topBar = document.getElementById('topBar');
            if (topBar) topBar.style.display = 'flex';
            updateUI();
            showPage('coachDashboardPage');
            if (typeof renderCoachDashboard === 'function') renderCoachDashboard();
            if (typeof startLobbyMusic === 'function') startLobbyMusic();
          }
          function _routeTrainee(profile) {
            appState.userRole = 'trainee';
            const greet = document.getElementById('userGreetingName');
            if (greet) greet.textContent = (profile.name || '').split(' ')[0];
            const topBar = document.getElementById('topBar');
            if (topBar) topBar.style.display = 'flex';
            updateUI();
            showPage('traineeDashboardPage');
            if (typeof startLobbyMusic === 'function') startLobbyMusic();
          }

          // â”€â”€ completeTraineeSignup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          window.completeTraineeSignup = async function() {
            _clearErr('traineeSignupError');
            if (!_fbGuard('traineeSignupError')) return;

            const name     = (document.getElementById('traineeSignupName')?.value     || '').trim();
            const email    = (document.getElementById('traineeSignupEmail')?.value    || '').trim();
            const phone    = (document.getElementById('traineeSignupPhone')?.value    || '').trim();
            const password = (document.getElementById('traineeSignupPassword')?.value || '').trim();
            const goal     =  document.getElementById('traineeSignupGoal')?.value     || '';

            if (!name || !email || !phone || !password || !goal) {
              _sound('playErrorSound');
              _showErr('traineeSignupError', 'âš ï¸ Please fill in all fields.');
              return;
            }
            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
              _sound('playErrorSound');
              _showErr('traineeSignupError', 'âš ï¸ Please enter a valid email address.');
              return;
            }
            if (password.length < 6) {
              _sound('playErrorSound');
              _showErr('traineeSignupError', 'âš ï¸ Password must be at least 6 characters.');
              return;
            }

            const emailNorm = normalizeEmail(email);
            _authInProgress = true;
            try {
              const cred = await createUserWithEmailAndPassword(fb.auth, emailNorm, password);
              await setDoc(doc(fb.db, 'profiles', cred.user.uid), {
                role: 'trainee', name, phone, goal,
                emailNormalized: emailNorm,
                createdAt: serverTimestamp()
              });
              _sound('playCompleteSound');
              _routeTrainee({ name });
            } catch (err) {
              console.error('[completeTraineeSignup]', err);
              _sound('playErrorSound');
              if (err.code === 'auth/email-already-in-use') {
                _showErr('traineeSignupError', 'âš ï¸ This email is already registered. Please log in.');
              } else if (err.code === 'auth/weak-password') {
                _showErr('traineeSignupError', 'âš ï¸ Password must be at least 6 characters.');
              } else {
                _showErr('traineeSignupError', 'âš ï¸ Signup failed: ' + (err.message || err.code));
              }
            } finally {
              _authInProgress = false;
            }
          };

          // â”€â”€ loginAsTrainee â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          window.loginAsTrainee = async function() {
            _clearErr('traineeLoginError');
            if (!_fbGuard('traineeLoginError')) return;

            const page    = document.getElementById('traineeLoginPage');
            const emailEl = page?.querySelector('[id="traineeLoginEmail"]')    ?? document.getElementById('traineeLoginEmail');
            const passEl  = page?.querySelector('[id="traineeLoginPassword"]') ?? document.getElementById('traineeLoginPassword');
            const email    = (emailEl?.value || '').trim();
            const password = (passEl?.value  || '').trim();

            if (!email || !password) {
              _sound('playErrorSound');
              _showErr('traineeLoginError', 'âš ï¸ Please enter both email and password.');
              return;
            }

            const emailNorm = normalizeEmail(email);
            _authInProgress = true;
            try {
              const cred = await signInWithEmailAndPassword(fb.auth, emailNorm, password);
              const snap = await getDoc(doc(fb.db, 'profiles', cred.user.uid));
              if (!snap.exists() || snap.data().role !== 'trainee') {
                await signOut(fb.auth);
                _sound('playErrorSound');
                _showErr('traineeLoginError', 'âš ï¸ No trainee account found for this email.');
                return;
              }
              _sound('playSuccessSound');
              _routeTrainee(snap.data());
            } catch (err) {
              console.error('[loginAsTrainee]', err);
              _sound('playErrorSound');
              const c = err.code || '';
              if (c === 'auth/user-not-found' || c === 'auth/invalid-credential' || c === 'auth/invalid-email') {
                _showErr('traineeLoginError', 'âš ï¸ No account found for this email. Please sign up.');
              } else if (c === 'auth/wrong-password') {
                _showErr('traineeLoginError', 'âš ï¸ Wrong password. Please try again.');
              } else {
                _showErr('traineeLoginError', 'âš ï¸ Login failed: ' + (err.message || c));
              }
            } finally {
              _authInProgress = false;
            }
          };

          // â”€â”€ completeCoachSignup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          // Coach 4-digit access code â†’ Firebase password = code + "00" (6 chars min)
          window.completeCoachSignup = async function() {
            _clearErr('coachSignupError');
            if (!_fbGuard('coachSignupError')) return;

            const name  = (document.getElementById('coachSignupName')?.value  || '').trim();
            const email = (document.getElementById('coachSignupEmail')?.value || '').trim();
            const phone = (document.getElementById('coachSignupPhone')?.value || '').trim();
            const code  = (document.getElementById('coachSignupCode')?.value  || '').trim();

            if (!name || !email || !phone || !code) {
              _sound('playErrorSound');
              _showErr('coachSignupError', 'âš ï¸ Please fill in all fields.');
              return;
            }
            if (!/^\d{4}$/.test(code)) {
              _sound('playErrorSound');
              _showErr('coachSignupError', 'âš ï¸ Access code must be exactly 4 digits.');
              return;
            }

            const emailNorm       = normalizeEmail(email);
            const derivedPassword = code + '00';
            _authInProgress = true;
            try {
              const cred = await createUserWithEmailAndPassword(fb.auth, emailNorm, derivedPassword);
              await setDoc(doc(fb.db, 'profiles', cred.user.uid), {
                role: 'coach', name, phone,
                emailNormalized: emailNorm,
                accessCode: code,
                createdAt: serverTimestamp()
              });
              _sound('playCompleteSound');
              _routeCoach({ name });
            } catch (err) {
              console.error('[completeCoachSignup]', err);
              _sound('playErrorSound');
              if (err.code === 'auth/email-already-in-use') {
                _showErr('coachSignupError', 'âš ï¸ This email is already registered. Please log in.');
              } else {
                _showErr('coachSignupError', 'âš ï¸ Signup failed: ' + (err.message || err.code));
              }
            } finally {
              _authInProgress = false;
            }
          };

          // â”€â”€ loginAsCoach â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          window.loginAsCoach = async function() {
            _clearErr('coachLoginError');
            if (!_fbGuard('coachLoginError')) return;

            const page    = document.getElementById('coachLoginPage');
            const emailEl = page?.querySelector('[id="coachLoginEmail"]') ?? document.getElementById('coachLoginEmail');
            const codeEl  = page?.querySelector('[id="coachLoginCode"]')  ?? document.getElementById('coachLoginCode');
            const email = (emailEl?.value || '').trim();
            const code  = (codeEl?.value  || '').trim();

            if (!email || !code) {
              _sound('playErrorSound');
              _showErr('coachLoginError', 'âš ï¸ Please enter both email and access code.');
              return;
            }

            const emailNorm       = normalizeEmail(email);
            const derivedPassword = code + '00';
            _authInProgress = true;
            try {
              const cred = await signInWithEmailAndPassword(fb.auth, emailNorm, derivedPassword);
              const snap = await getDoc(doc(fb.db, 'profiles', cred.user.uid));
              if (!snap.exists() || snap.data().role !== 'coach' || snap.data().accessCode !== code) {
                await signOut(fb.auth);
                _sound('playErrorSound');
                _showErr('coachLoginError', 'âš ï¸ Invalid credentials. Check your email and access code.');
                return;
              }
              _sound('playCompleteSound');
              _routeCoach(snap.data());
            } catch (err) {
              console.error('[loginAsCoach]', err);
              _sound('playErrorSound');
              const c = err.code || '';
              if (c === 'auth/user-not-found' || c === 'auth/invalid-credential' || c === 'auth/wrong-password') {
                _showErr('coachLoginError', 'âš ï¸ No coach account found or wrong access code.');
              } else {
                _showErr('coachLoginError', 'âš ï¸ Login failed: ' + (err.message || c));
              }
            } finally {
              _authInProgress = false;
            }
          };

          // â”€â”€ logout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          window.logout = async function() {
            if (!confirm('Are you sure you want to sign out?')) return;
            _sound('playBuddySound');
            if (!window.__FIREBASE_READY__ || !window.fb?.auth) {
              showPage('signup');
              return;
            }
            try { await signOut(fb.auth); } catch (e) { console.error('signOut error:', e); }
            if (typeof stopLobbyMusic === 'function') stopLobbyMusic();
            appState.userRole = 'trainee';
            if (typeof hideBuddySpeech === 'function') hideBuddySpeech();
            const exitBtn = document.getElementById('exitBtn');
            const topBar  = document.getElementById('topBar');
            if (exitBtn) exitBtn.style.display = 'none';
            if (topBar)  topBar.style.display  = 'none';
            showPage('signup');
          };

          // â”€â”€ onAuthStateChanged â€” session restore on page load â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          // Lives INSIDE the try block so it only runs when fb.auth is valid.
          // _authInProgress prevents it from racing with signup/login flows.
          onAuthStateChanged(fb.auth, async (user) => {
            if (_authInProgress) return;

            const topBar = document.getElementById('topBar');

            if (!user) {
              if (topBar) topBar.style.display = 'none';
              showPage('signup');
              return;
            }

            try {
              const snap = await getDoc(doc(fb.db, 'profiles', user.uid));
              if (!snap.exists()) {
                console.warn('[onAuthStateChanged] Auth user has no Firestore profile. Signing out.');
                await signOut(fb.auth);
                if (topBar) topBar.style.display = 'none';
                showPage('signup');
                return;
              }
              const profile = snap.data();
              if (topBar) topBar.style.display = 'flex';
              if (profile.role === 'coach') {
                _routeCoach(profile);
              } else {
                _routeTrainee(profile);
              }
            } catch (err) {
              console.error('[onAuthStateChanged] Firestore error:', err);
              if (topBar) topBar.style.display = 'none';
              showPage('signup');
            }
          });

    </script>



    <!-- C: Lobby music -->
    <audio id="lobbyMusic" loop preload="auto">
        <source src="lobby.mp3" type="audio/mpeg">
    </audio>
    <div id="musicEnableBanner" onclick="userEnableMusic()">Tap to enable music</div>
    <div id="lobbyMusicPanel">
        <div class="mp-row"><span class="mp-label">Lobby Music</span>
            <button class="mp-toggle" id="musicToggleBtn" onclick="toggleLobbyMusic()">Off</button></div>
        <div class="mp-row" style="margin-bottom:0;"><span class="mp-label">Vol</span>
            <input type="range" min="0" max="100" value="25" id="musicVolSlider"
                   oninput="setLobbyVolume(this.value/100)"></div>
    </div>

    <!-- Mini debug bubble (Task 2) -->
    <div id="miniDebug" style="position:fixed;left:10px;bottom:10px;z-index:99999;background:#111;color:#fff;padding:8px 10px;border-radius:10px;font-family:monospace;font-size:12px;max-width:90vw;opacity:.92;">
      debug: loaded
    </div>

</body>
</html>
